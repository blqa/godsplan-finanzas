<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Finanzas</title>
    
    <!-- FAVICON -->
    <link rel="shortcut icon" href="./favicon.ico?v=2" type="image/x-icon">

    <!-- FUENTE UNIFICADA: PLUS JAKARTA SANS -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- SCRIPT DE ICONOS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- TAILWIND CSS & CONFIGURACIÓN DE TEMA -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                        'text-mute': 'var(--text-mute)',
                        brand: 'var(--brand)',
                        'login-brand': 'var(--login-brand)',
                        money: 'var(--money)',
                        alert: 'var(--alert)',
                        warn: 'var(--warn)',
                        border: 'var(--border)',
                        'input-bg': 'var(--input-bg)',
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'nebula': 'nebula 20s infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        nebula: { '0%': { transform: 'scale(1)', opacity: '0.3' }, '100%': { transform: 'scale(1.2)', opacity: '0.6' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { from: { opacity: 0, transform: 'translateY(-5px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        scaleIn: { from: { opacity: 0, transform: 'scale(0.95)' }, to: { opacity: 1, transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg: #000000;
            --card: #111111;
            --border: #262626;
            --input-bg: #0a0a0a;
            --text: #e5e5e5;
            --text-mute: #737373;
            --brand: #dc2626;
            --login-brand: #E70000;
            --money: #16a34a;
            --alert: #b91c1c;
            --warn: #d97706;
            --header-bg: rgba(0, 0, 0, 0.85);
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { overflow-x: hidden; background-color: var(--bg); color: var(--text); }
        
        /* Utility para ocultar scrollbars pero permitir scroll */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .animate-pulse-custom { animation: pulse 2s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { border: 4px solid var(--border); border-top: 4px solid var(--brand); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }

        .aurora-bg {
            position: fixed; inset: 0; z-index: -2;
            background: radial-gradient(circle at 50% 50%, rgba(50, 0, 0, 0.4) 0%, transparent 60%),
                        radial-gradient(circle at 80% 20%, rgba(231, 0, 0, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 20% 80%, rgba(100, 0, 0, 0.2) 0%, transparent 40%);
            filter: blur(80px);
            pointer-events: none;
        }

        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        .input-gp {
            background: var(--input-bg); border: 1px solid var(--border); color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; padding: 14px 16px; border-radius: 12px;
            font-size: 0.95rem; font-weight: 600; font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .input-gp:focus { border-color: var(--brand); outline: none; background: rgba(220, 38, 38, 0.05); box-shadow: 0 0 20px rgba(220, 38, 38, 0.1); transform: translateY(-1px); }
        .input-gp::placeholder { color: var(--text-mute); }
        /* Fix date inputs dark scheme */
        input[type="date"], input[type="datetime-local"], input[type="time"] { color-scheme: dark; }

        .glass-panel {
            background: rgba(17, 17, 17, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .auth-switch { position: relative; display: flex; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 4px; margin-bottom: 24px; border: 1px solid var(--border); }
        .auth-switch button { flex: 1; padding: 8px; font-size: 0.8rem; font-weight: 800; z-index: 1; color: var(--text-mute); transition: 0.3s; cursor: pointer; letter-spacing: 0.05em; }
        .auth-switch button.active { color: white; }
        .auth-switch-glider {
            position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); width: calc(50% - 4px);
            background: var(--card); border-radius: 8px; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(255,255,255,0.1);
        }
        .auth-mode-register .auth-switch-glider { transform: translateX(100%); }

        .btn-glow { position: relative; overflow: hidden; background: var(--login-brand); color: white; transition: all 0.3s; cursor: pointer; border: none; }
        .btn-glow:hover { box-shadow: 0 0 30px rgba(220, 38, 38, 0.4); transform: translateY(-2px); }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
        .modal-overlay.is-open { display: flex; }
        .modal-content { background: var(--card); width: 100%; max-width: 400px; border-radius: 20px; border: 1px solid var(--border); padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.7); position: relative; }

        .chip { border: 1px solid var(--border); background: var(--input-bg); color: var(--text-mute); padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .chip.active { background: var(--text); color: var(--bg); border-color: var(--text); transform: scale(1.02); }

        #toast { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; }
        
        /* Estilos para las bolitas de deuda */
        .debt-bubble {
            width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 800; transition: all 0.2s; cursor: pointer; border: 1px solid var(--border);
            background: var(--input-bg); color: var(--text-mute);
        }
        .debt-bubble.paid {
            background: var(--money); border-color: var(--money); color: white; box-shadow: 0 0 10px rgba(22, 163, 74, 0.4);
        }
        .debt-bubble:hover { transform: scale(1.1); }

        /* Timeline Styles for History */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--border) 0%, transparent 100%);
            z-index: 0;
        }
        .timeline-item { position: relative; padding-left: 50px; margin-bottom: 24px; }
        .timeline-dot {
            position: absolute; left: 18px; top: 0;
            width: 14px; height: 14px; border-radius: 50%;
            background: var(--card); border: 2px solid var(--border);
            z-index: 10;
        }
        .timeline-dot.income { border-color: var(--money); box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.1); }
        .timeline-dot.expense { border-color: var(--brand); box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1); }
        
        /* Sticky header fix for History */
        .sticky-date {
            position: sticky; top: 70px; z-index: 10;
            display: inline-block;
            backdrop-filter: blur(8px);
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-bg text-text font-sans selection:bg-brand selection:text-white flex flex-col h-[100dvh] overflow-hidden">

    <!-- FONDOS ANIMADOS -->
    <div class="aurora-bg"></div>
    <div class="grid-bg"></div>

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 bg-bg z-[2000] flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-text-mute font-mono text-xs tracking-widest uppercase">Cargando...</p>
        </div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-[#030000] hidden">
        <div class="absolute top-8 left-8 flex items-center gap-3 animate-fade-in opacity-50">
             <div class="relative w-8 h-8 flex items-center justify-center"><i class="ph-fill ph-wallet text-2xl text-brand"></i></div>
            <span class="font-bold tracking-widest text-lg">GOD'S PLAN</span>
        </div>
        <div class="w-full max-w-md animate-float">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-2">FINANZAS</h1>
                <p class="text-zinc-500 text-sm font-mono tracking-widest uppercase">Control Financiero Estricto</p>
            </div>
            
            <div class="glass-panel rounded-3xl p-8 relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-1 bg-brand blur-md opacity-50"></div>
                
                <div id="auth-switcher-container" class="auth-switch">
                    <div class="auth-switch-glider"></div>
                    <button onclick="window.authApp.toggleAuth('login')" id="tab-login" class="active">INGRESAR</button>
                    <button onclick="window.authApp.toggleAuth('register')" id="tab-register">REGISTRO</button>
                </div>

                <form onsubmit="event.preventDefault(); window.authApp.handleAuthSubmit();" class="flex flex-col gap-4">
                    <div id="field-name" class="hidden">
                        <div class="relative group">
                            <i class="ph-bold ph-user absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                            <input type="text" id="input-name" class="input-gp pl-12" placeholder="Tu Nombre">
                        </div>
                    </div>
                    <div class="relative group">
                        <i class="ph-bold ph-identification-card absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                        <input type="text" id="input-id" class="input-gp pl-12" placeholder="Usuario o Email" required>
                    </div>
                    <div class="relative group">
                        <i class="ph-bold ph-lock-key absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 group-focus-within:text-brand transition-colors"></i>
                        <input type="password" id="input-pass" class="input-gp pl-12" placeholder="Contraseña" required>
                    </div>

                    <div id="auth-error-msg" class="hidden p-3 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-xs font-bold text-center flex items-center justify-center gap-2">
                          <i class="ph-fill ph-warning-circle"></i> <span id="auth-error-txt">Error</span>
                    </div>

                    <button type="submit" id="btn-submit" class="btn-glow w-full py-4 rounded-xl font-black uppercase tracking-widest text-sm mt-2 flex items-center justify-center gap-2 group">
                        <span id="btn-text">INICIAR SESIÓN</span> <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </form>
            </div>
        </div>
        <footer class="absolute bottom-4 left-0 w-full text-center pointer-events-none opacity-30">
            <p class="text-[10px] font-mono tracking-[0.5em] text-white">SYSTEM v2.0 // SECURE</p>
        </footer>
    </div>
    
    <!-- HEADER APP MEJORADO -->
    <nav id="global-nav" class="bg-black/90 backdrop-blur-md border-b border-white/5 fixed top-0 left-0 w-full z-50 flex items-center justify-between px-4 py-0 h-[60px] shadow-lg transition-all hidden">
        <div class="flex items-center gap-3">
             <div class="w-8 h-8 bg-gradient-to-br from-card to-input-bg rounded-full flex items-center justify-center text-brand border border-white/10 shadow-inner">
                <i class="ph-fill ph-wallet text-lg"></i>
            </div>
            <div>
                <h1 class="text-white font-black text-xs uppercase tracking-widest leading-none">God's Plan</h1>
                <p class="text-[9px] text-text-mute font-medium mt-0.5" id="current-view-title">Finanzas</p>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <p class="text-[10px] text-text-mute font-mono font-bold border border-white/10 px-2 py-1 rounded-md bg-white/5" id="current-date-header">...</p>
        </div>

        <!-- Menú Desktop -->
        <div class="hidden md:flex gap-1 absolute left-1/2 -translate-x-1/2 bg-input-bg/50 p-1 rounded-xl border border-white/10 backdrop-blur-sm">
            <button id="desktop-nav-dashboard" onclick="switchTab('dashboard')" class="px-4 py-2 rounded-lg text-xs font-bold text-white bg-bg shadow-sm transition-all">Panel</button>
            <button id="desktop-nav-history" onclick="switchTab('history')" class="px-4 py-2 rounded-lg text-xs font-bold text-text-mute hover:text-white transition-all">Historial</button>
            <button id="desktop-nav-payments" onclick="switchTab('payments')" class="px-4 py-2 rounded-lg text-xs font-bold text-text-mute hover:text-white transition-all">Pagos</button>
            <button id="desktop-nav-settings" onclick="switchTab('settings')" class="px-4 py-2 rounded-lg text-xs font-bold text-text-mute hover:text-white transition-all">Ajustes</button>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main id="main-container" class="flex-1 overflow-y-auto p-4 md:px-6 md:pb-6 pt-20 pb-28 relative hidden scroll-smooth w-full max-w-[900px] mx-auto hide-scrollbar">
        
        <!-- DASHBOARD -->
        <section id="view-dashboard" class="space-y-6 animate-fade-in">

            <!-- Fórmula del Día -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-card border border-border rounded-2xl p-6 flex flex-col justify-between relative overflow-hidden h-full shadow-sm">
                    <div>
                          <div class="flex justify-between items-start mb-4">
                            <p class="text-xs font-black text-violet-400 uppercase tracking-widest flex items-center gap-2">
                                <i class="ph-fill ph-calculator"></i> PLAN DEL DÍA
                            </p>
                            <div class="flex items-center gap-2">
                                <i id="savings-active-icon" class="ph-fill ph-shield-check text-emerald-500 text-lg hidden" title="Ahorro Protegido"></i>
                                <span id="payday-badge" class="text-[10px] bg-violet-900/20 text-violet-300 px-2 py-0.5 rounded border border-violet-500/20 font-bold uppercase">...</span>
                            </div>
                        </div>
                        <p class="text-sm text-text-mute leading-relaxed mb-4 font-medium" id="formula-explanation">Analizando tus finanzas...</p>
                    </div>
                    
                    <div class="pt-4 border-t border-border mt-auto">
                        <div class="flex justify-between items-end">
                            <div>
                                <p class="text-[10px] text-text-mute uppercase font-black mb-1">Límite Diario</p>
                                <span class="font-black text-3xl text-text tracking-tight" id="formula-daily">$0.00</span>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-text-mute font-black uppercase">Pendientes</p>
                                <p id="formula-days-left" class="text-xs font-bold text-text-mute">...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción (SOLO PC - hidden en móvil, grid en md) -->
                <div class="hidden md:grid grid-rows-2 gap-4 h-full">
                    <button onclick="openAddModal('income')" class="bg-card border border-border hover:bg-input-bg rounded-2xl text-money font-black text-sm flex items-center justify-center gap-3 transition-all group relative overflow-hidden">
                         <div class="absolute left-0 top-0 w-1 h-full bg-money"></div>
                        <div class="w-10 h-10 rounded-xl bg-green-900/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="ph-bold ph-arrow-down-left text-xl"></i>
                        </div>
                        <span class="tracking-wide">REGISTRAR INGRESO</span>
                    </button>
                    <button onclick="openAddModal('expense')" class="bg-card border border-border hover:bg-input-bg rounded-2xl text-brand font-black text-sm flex items-center justify-center gap-3 transition-all group relative overflow-hidden">
                        <div class="absolute left-0 top-0 w-1 h-full bg-brand"></div>
                        <div class="w-10 h-10 rounded-xl bg-red-900/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="ph-bold ph-minus text-xl"></i>
                        </div>
                        <span class="tracking-wide">REGISTRAR GASTO</span>
                    </button>
                </div>
            </div>
            
            <!-- Tarjeta de Balance -->
            <div class="glass-panel rounded-2xl p-6 relative overflow-hidden group border border-border">
                <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                    <i class="ph-fill ph-wallet text-9xl text-white"></i>
                </div>

                <div class="flex justify-between items-start mb-4 relative z-10">
                    <span class="text-xs font-black text-text-mute uppercase tracking-widest flex items-center gap-2"><i class="ph-bold ph-coins"></i> Disponible (Visible)</span>
                    <button onclick="openAdjustModal()" class="text-text-mute hover:text-white text-[0.65rem] font-bold bg-bg/50 px-2 py-1 rounded border border-border transition-colors uppercase tracking-wider">Ajustar</button>
                </div>
                
                <div class="text-[clamp(2.5rem,5vw,3.5rem)] font-black text-text mb-6 relative z-10 tracking-tight leading-none" id="total-balance">$0.00</div>
                
                <div class="mb-6 relative z-10">
                    <div class="flex justify-between text-[10px] font-bold text-text-mute mb-2 uppercase tracking-wide">
                        <span>Presupuesto usado</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="h-2 bg-black/50 rounded-full w-full overflow-hidden border border-white/5">
                        <div id="balance-progress" class="h-full bg-white w-0 transition-all duration-700 ease-out shadow-[0_0_15px_rgba(255,255,255,0.5)]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4 relative z-10">
                    <div>
                        <span class="block text-[10px] text-text-mute uppercase font-black mb-1 flex items-center gap-1"><i class="ph-bold ph-arrow-down-left text-money"></i> Ingresos</span>
                        <span class="text-xl font-bold text-money tracking-tight" id="total-income">$0.00</span>
                    </div>
                    <div class="text-right">
                        <span class="block text-[10px] text-text-mute uppercase font-black mb-1 flex items-center justify-end gap-1">Gastos <i class="ph-bold ph-arrow-up-right text-brand"></i></span>
                        <span class="text-xl font-bold text-brand tracking-tight" id="total-expense">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Resumen Financiero Situacional (NUEVO) -->
            <div class="bg-input-bg border border-border rounded-2xl p-4 grid grid-cols-2 gap-4">
                <div class="flex flex-col">
                    <p class="text-[10px] text-text-mute uppercase font-black mb-1 flex items-center gap-1"><i class="ph-fill ph-trend-down text-brand"></i> Deuda Total</p>
                    <p class="text-lg font-bold text-text tracking-tight" id="dashboard-total-debt">$0.00</p>
                    <p class="text-[9px] text-text-mute leading-none mt-1">Plazos restantes</p>
                </div>
                <div class="flex flex-col text-right">
                    <p class="text-[10px] text-text-mute uppercase font-black mb-1 flex items-center justify-end gap-1">Préstamos <i class="ph-fill ph-handshake text-blue-400"></i></p>
                    <p class="text-lg font-bold text-text tracking-tight" id="dashboard-loans-net">$0.00</p>
                    <p class="text-[9px] text-text-mute leading-none mt-1">Balance (Me deben - Debo)</p>
                </div>
            </div>

            <!-- SIMULADOR (Oculto por defecto) -->
            <div id="simulation-container" class="hidden bg-blue-900/10 border border-blue-500/20 rounded-2xl p-6 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-4 border-b border-blue-500/20 pb-3">
                        <i class="ph-fill ph-magic-wand text-blue-400 text-xl"></i>
                        <h3 class="text-sm font-black text-blue-100 uppercase tracking-wide">Simulador de Futuro</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-blue-300/70 block mb-1">Fecha Futura</label>
                                    <input type="date" id="sim-date" class="input-gp bg-black/40 border-blue-500/30 text-xs py-2" onchange="runSimulation()">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-blue-300/70 block mb-1">Monto a Recibir</label>
                                    <input type="number" id="sim-amount" class="input-gp bg-black/40 border-blue-500/30 text-xs py-2" placeholder="0.00" oninput="runSimulation()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-black/40 rounded-xl p-4 flex flex-col justify-center border border-blue-900/30 text-center">
                            <p class="text-xs text-blue-300/70 mb-1 font-bold uppercase">Nuevo límite diario proyectado</p>
                            <p class="text-3xl font-black text-blue-400 tracking-tight" id="sim-result">$0.00</p>
                            <p class="text-[10px] text-text-mute mt-1 font-mono" id="sim-details">Esperando datos...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista Reciente -->
            <div>
                 <div class="flex justify-between items-center mb-4 px-1 border-b border-border pb-2">
                     <h3 class="text-xs font-black text-text-mute uppercase tracking-widest">Actividad Reciente</h3>
                     <button onclick="switchTab('history')" class="text-xs font-bold text-brand hover:text-white transition-colors flex items-center gap-1">Ver Todo <i class="ph-bold ph-arrow-right"></i></button>
                </div>
                <div id="recent-list" class="space-y-3">
                    <!-- Items se inyectan aquí -->
                </div>
            </div>

        </section>

        <!-- HISTORIAL MEJORADO -->
        <section id="view-history" class="hidden animate-fade-in relative min-h-screen pb-10">
            <!-- Sticky Filter Bar -->
            <div class="sticky top-0 bg-bg/95 backdrop-blur-xl z-20 py-3 border-b border-border mb-6 -mx-4 px-4 flex items-center gap-3 overflow-x-auto hide-scrollbar">
                <button onclick="filterHistory('all')" class="filter-btn active chip shrink-0" data-filter="all">Todos</button>
                <button onclick="filterHistory('income')" class="filter-btn chip shrink-0" data-filter="income">Ingresos</button>
                <button onclick="filterHistory('expense')" class="filter-btn chip shrink-0" data-filter="expense">Gastos</button>
                <div class="w-4 shrink-0"></div> <!-- Spacer for scroll -->
            </div>
            
            <div id="full-history-list" class="relative">
                <div class="timeline-line"></div>
                <!-- Content injected via JS -->
            </div>
        </section>

        <!-- PAGOS Y DEUDAS -->
        <section id="view-payments" class="hidden space-y-8 animate-fade-in">
            
            <!-- Sección Deudas a Plazos (NUEVA) -->
            <div class="space-y-4">
                 <div class="flex items-center justify-between border-b border-border pb-2">
                    <h2 class="text-lg font-black text-text uppercase tracking-wide flex items-center gap-2"><i class="ph-bold ph-chart-bar-horizontal text-blue-500"></i> Deudas a Plazos</h2>
                    <button onclick="openDebtModal()" class="bg-input-bg border border-border hover:bg-white/5 text-text px-3 py-1.5 rounded-lg font-bold text-xs flex items-center gap-2 transition-colors">
                        <i class="ph-bold ph-plus"></i> Nuevo
                    </button>
                </div>
                <div id="debts-list" class="grid grid-cols-1 gap-4">
                    <!-- Deudas aquí -->
                </div>
            </div>

            <!-- Sección Fijos -->
            <div class="space-y-4 pt-6 border-t border-border">
                <div class="flex items-center justify-between border-b border-border pb-2">
                    <h2 class="text-lg font-black text-text uppercase tracking-wide flex items-center gap-2"><i class="ph-bold ph-calendar-check text-brand"></i> Pagos Fijos</h2>
                    <button onclick="openModal('fixed-modal')" class="bg-input-bg border border-border hover:bg-white/5 text-text px-3 py-1.5 rounded-lg font-bold text-xs flex items-center gap-2 transition-colors">
                        <i class="ph-bold ph-plus"></i> Nuevo
                    </button>
                </div>
                <!-- Contenedor dividido en Q1 y Q2 -->
                <div id="fixed-container" class="space-y-6">
                    <!-- Inyectado por JS -->
                </div>
            </div>

            <!-- Sección Préstamos -->
            <div class="space-y-4 pt-6 border-t border-border">
                <div class="flex items-center justify-between border-b border-border pb-2">
                    <h2 class="text-lg font-black text-text uppercase tracking-wide flex items-center gap-2"><i class="ph-bold ph-handshake text-brand"></i> Préstamos</h2>
                    <button onclick="openLoanModal()" class="bg-input-bg border border-border hover:bg-white/5 text-text px-3 py-1.5 rounded-lg font-bold text-xs flex items-center gap-2 transition-colors">
                        <i class="ph-bold ph-plus"></i> Nuevo
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-card border border-border p-4 rounded-xl text-center">
                        <p class="text-[10px] text-text-mute uppercase font-black mb-1">Me deben</p>
                        <p class="text-xl font-black text-money tracking-tight" id="loans-owed-to-me">$0.00</p>
                    </div>
                    <div class="bg-card border border-border p-4 rounded-xl text-center">
                        <p class="text-[10px] text-text-mute uppercase font-black mb-1">Debo</p>
                        <p class="text-xl font-black text-brand tracking-tight" id="loans-i-owe">$0.00</p>
                    </div>
                </div>

                <div id="loans-list" class="space-y-2"></div>
            </div>
        </section>

        <!-- AJUSTES -->
        <section id="view-settings" class="hidden space-y-6 animate-fade-in">
            <h2 class="text-lg font-black text-text uppercase tracking-wide border-b border-border pb-4">Configuración</h2>
            
            <div class="bg-card border border-border p-6 rounded-2xl">
                <div class="flex items-center gap-4 mb-6 pb-6 border-b border-border">
                    <div class="w-12 h-12 bg-input-bg rounded-full flex items-center justify-center text-text border border-border">
                        <i class="ph-bold ph-user text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-text text-lg" id="user-display-name">Usuario</h3>
                        <p class="text-xs text-text-mute font-mono" id="user-display-email">ID</p>
                    </div>
                </div>
                
                <button onclick="window.authApp.logout()" class="w-full py-3 border border-alert bg-alert/10 text-alert text-xs font-black rounded-xl hover:bg-alert/20 transition-colors uppercase tracking-widest">
                    CERRAR SESIÓN
                </button>
            </div>

            <div class="bg-card border border-border p-6 rounded-2xl space-y-5">
                <h3 class="font-bold text-text text-sm flex items-center gap-2 uppercase tracking-wide"><i class="ph-bold ph-calendar text-brand"></i> Frecuencia de Cobro</h3>
                
                <div class="space-y-2">
                    <label class="flex items-center gap-3 p-3 bg-input-bg border border-border rounded-xl cursor-pointer hover:border-brand transition-colors">
                        <input type="radio" name="pay-freq" value="biweekly" class="accent-brand w-4 h-4" onchange="togglePaydayInput()">
                        <span class="text-sm text-text font-bold">Quincenal (15 y 30)</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-input-bg border border-border rounded-xl cursor-pointer hover:border-brand transition-colors">
                        <input type="radio" name="pay-freq" value="biweekly-custom" class="accent-brand w-4 h-4" onchange="togglePaydayInput()">
                        <span class="text-sm text-text font-bold">Quincenal (Personalizado)</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 bg-input-bg border border-border rounded-xl cursor-pointer hover:border-brand transition-colors">
                        <input type="radio" name="pay-freq" value="monthly" class="accent-brand w-4 h-4" onchange="togglePaydayInput()">
                        <span class="text-sm text-text font-bold">Mensual</span>
                    </label>
                </div>

                <div id="monthly-select-container" class="hidden animate-fade-in">
                    <label class="text-[10px] text-text-mute font-black uppercase block mb-1">Día de pago</label>
                    <select id="payday-select" class="input-gp bg-input-bg text-xs py-2"></select>
                </div>

                <div id="biweekly-custom-container" class="hidden grid grid-cols-2 gap-4 animate-fade-in">
                    <div>
                        <label class="text-[10px] text-text-mute font-black uppercase block mb-1">Día 1</label>
                        <select id="payday-1-select" class="input-gp bg-input-bg text-xs py-2"></select>
                    </div>
                    <div>
                        <label class="text-[10px] text-text-mute font-black uppercase block mb-1">Día 2</label>
                        <select id="payday-2-select" class="input-gp bg-input-bg text-xs py-2"></select>
                    </div>
                </div>
                
                <button onclick="saveSettings()" class="w-full bg-brand text-white py-3 rounded-xl font-bold text-xs hover:bg-red-600 mt-2 shadow-lg shadow-brand/20 transition-colors uppercase tracking-widest">GUARDAR</button>
            </div>
            
             <div class="bg-card border border-border p-6 rounded-2xl space-y-4">
                  <h3 class="font-bold text-text text-sm flex items-center gap-2 uppercase tracking-wide"><i class="ph-bold ph-faders text-brand"></i> Extras</h3>
                  
                  <!-- NUEVO SELECTOR DE AHORRO -->
                  <div class="flex items-center justify-between p-2 hover:bg-input-bg rounded-lg transition-colors">
                     <div>
                          <span class="text-sm text-text font-bold">Modo "Ahorro Forzoso"</span>
                          <p class="text-[10px] text-text-mute font-medium">Oculta un porcentaje de tu saldo.</p>
                     </div>
                     <select id="savings-percent" class="input-gp w-28 px-2 py-1 text-xs bg-input-bg text-right h-8 flex items-center" onchange="saveSettings()">
                         <option value="0">Off</option>
                         <option value="5">5%</option>
                         <option value="10">10%</option>
                         <option value="15">15%</option>
                     </select>
                 </div>

                <div class="border-t border-border"></div>
                <label class="flex items-center justify-between cursor-pointer p-2 hover:bg-input-bg rounded-lg transition-colors">
                    <div>
                        <span class="text-sm text-text font-bold">Habilitar Simulador</span>
                        <p class="text-[10px] text-text-mute font-medium">Calculadora para ingresos futuros.</p>
                    </div>
                    <input type="checkbox" id="toggle-simulation" class="accent-brand w-5 h-5" onchange="saveSettings()">
                </label>
             </div>

            <div class="bg-card border border-border p-6 rounded-2xl">
                <h3 class="font-bold text-text text-sm mb-4 uppercase tracking-wide">Gestión de Datos</h3>
                <div class="flex gap-3">
                    <button onclick="exportData()" class="flex-1 bg-input-bg border border-border py-3 rounded-xl text-xs font-bold text-text hover:bg-bg transition-colors border-dashed flex items-center justify-center gap-2"><i class="ph-bold ph-download-simple"></i> JSON</button>
                    <button onclick="document.getElementById('import-file').click()" class="flex-1 bg-input-bg border border-border py-3 rounded-xl text-xs font-bold text-text hover:bg-bg transition-colors border-dashed flex items-center justify-center gap-2"><i class="ph-bold ph-upload-simple"></i> Importar</button>
                    <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                </div>
                <button onclick="resetApp()" class="w-full mt-6 text-brand text-[10px] font-black uppercase hover:text-red-400 transition-colors flex items-center justify-center gap-2"><i class="ph-bold ph-trash"></i> Eliminar todos los datos</button>
            </div>
        </section>
    </main>

    <!-- Barra Inferior Móvil (Estilo Adherencia) -->
    <nav class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] bg-card/90 backdrop-blur-xl border border-border rounded-2xl h-16 grid grid-cols-5 z-40 shadow-2xl items-center px-2" id="bottom-nav">
        <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center justify-center text-white transition-colors gap-1" id="nav-dashboard">
            <i class="ph-fill ph-squares-four text-2xl"></i>
        </button>
        <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center justify-center text-text-mute hover:text-white transition-colors gap-1" id="nav-history">
             <i class="ph-fill ph-list-dashes text-2xl"></i>
        </button>
        
        <!-- Botón Central Flotante -->
        <div class="relative flex justify-center items-center pointer-events-none -top-6">
            <button onclick="openAddModal('expense')" class="pointer-events-auto w-14 h-14 bg-brand rounded-full flex items-center justify-center text-white shadow-[0_0_20px_rgba(220,38,38,0.5)] hover:scale-105 active:scale-95 transition-transform border-4 border-bg">
                <i class="ph-bold ph-plus text-2xl"></i>
            </button>
        </div>

        <button onclick="switchTab('payments')" class="nav-btn flex flex-col items-center justify-center text-text-mute hover:text-white transition-colors gap-1" id="nav-payments">
             <i class="ph-fill ph-receipt text-2xl"></i>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center justify-center text-text-mute hover:text-white transition-colors gap-1" id="nav-settings">
             <i class="ph-fill ph-gear text-2xl"></i>
        </button>
    </nav>

    <!-- MODALES -->
    
    <!-- Transacción -->
    <div id="transaction-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
             <div class="flex justify-between items-center mb-6 border-b border-border pb-4">
                <h3 class="font-black text-text text-lg uppercase tracking-wide" id="modal-tx-title">Nuevo Movimiento</h3>
                <button onclick="closeModal('transaction-modal')" class="w-8 h-8 rounded-full bg-input-bg flex items-center justify-center text-text-mute hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
             </div>
             
             <form id="transaction-form" onsubmit="addTransaction(event)">
                <div class="hidden">
                      <input type="radio" name="type" value="expense" id="radio-expense" checked>
                      <input type="radio" name="type" value="income" id="radio-income">
                      <input type="hidden" id="t-fixed-id">
                </div>
                
                <div class="mb-8 text-center">
                    <label class="text-[10px] uppercase font-bold text-text-mute block mb-2">Monto</label>
                    <div class="relative inline-block w-full">
                        <span class="absolute left-8 top-1/2 -translate-y-1/2 text-2xl font-bold text-text-mute">$</span>
                        <input type="number" id="t-amount" step="0.01" class="w-full bg-transparent border-b-2 border-border text-4xl font-black text-text py-2 pl-12 pr-2 text-center focus:border-brand transition-colors placeholder-zinc-800" placeholder="0.00" required>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="text-[10px] uppercase font-bold text-text-mute block mb-3 text-center">Categoría</label>
                    <div class="flex flex-wrap gap-2 justify-center" id="category-chips"></div>
                    <input type="hidden" id="t-category" required>
                </div>
                
                <div class="space-y-4 mb-8 bg-input-bg p-4 rounded-xl border border-border">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Concepto</label>
                        <input type="text" id="t-title" class="input-gp bg-bg border-border" placeholder="Descripción corta...">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Fecha</label>
                        <input type="datetime-local" id="t-date" class="input-gp bg-bg border-border" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button type="button" id="btn-delete-tx" onclick="deleteCurrentTransaction()" class="hidden py-3 border border-alert bg-alert/10 text-alert font-bold text-xs rounded-xl hover:bg-alert/20 transition-colors uppercase">ELIMINAR</button>
                    <button type="submit" id="btn-save-tx" class="col-span-2 py-3 bg-brand text-white font-bold text-xs rounded-xl hover:bg-red-600 shadow-lg shadow-brand/20 transition-colors uppercase tracking-widest">GUARDAR</button>
                </div>
             </form>
        </div>
    </div>

    <!-- Ajustar Saldo -->
    <div id="adjust-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in text-center">
             <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-text">Ajustar Saldo Real</h3>
                <button onclick="closeModal('adjust-modal')" class="w-8 h-8 rounded-full bg-input-bg flex items-center justify-center text-text-mute hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
             </div>
             <div class="bg-input-bg border border-border p-6 rounded-2xl mb-6">
                 <p class="text-xs text-text-mute uppercase font-bold mb-1">El sistema calcula:</p>
                 <p class="text-3xl font-black text-text tracking-tight" id="adjust-current-display">$0.00</p>
             </div>
             <form onsubmit="submitAdjustment(event)">
                <div class="mb-6">
                    <label class="text-[10px] uppercase font-bold text-text-mute block mb-2">¿Cuánto tienes realmente?</label>
                    <input type="number" id="adjust-amount" step="0.01" class="input-gp text-3xl font-bold text-center" placeholder="0.00" required>
                    <p class="text-[10px] text-text-mute mt-2">Se creará un movimiento de "Ajuste" automáticamente.</p>
                </div>
                <button type="submit" class="w-full bg-brand text-white py-3 rounded-xl font-bold text-xs hover:bg-red-600 shadow-lg shadow-brand/20 transition-colors uppercase tracking-widest">CORREGIR SALDO</button>
             </form>
        </div>
    </div>

    <!-- Modal Fijo -->
    <div id="fixed-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
            <div class="flex justify-between items-center mb-6 border-b border-border pb-4">
                <h3 class="font-black text-text uppercase">Nuevo Pago Fijo</h3>
                <button onclick="closeModal('fixed-modal')" class="w-8 h-8 rounded-full bg-input-bg flex items-center justify-center text-text-mute hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
             </div>
             <form id="fixed-form" onsubmit="addFixed(event)" class="space-y-5">
                 <div>
                      <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Nombre del Servicio</label>
                      <input type="text" id="f-title" class="input-gp" placeholder="Ej. Netflix, Renta..." required>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Monto Mensual</label>
                        <input type="number" id="f-amount" step="0.01" class="input-gp" placeholder="0.00" required>
                      </div>
                      <div>
                        <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Día del mes</label>
                        <select id="f-day" class="input-gp bg-input-bg"></select>
                      </div>
                 </div>
                 <label class="flex items-center gap-3 cursor-pointer p-3 bg-input-bg border border-border rounded-xl">
                    <input type="checkbox" id="f-include" class="accent-brand w-4 h-4" checked>
                    <span class="text-xs text-text font-bold">Descontar del Plan Diario</span>
                 </label>
                 <button type="submit" class="w-full bg-brand text-white py-3 rounded-xl font-bold text-xs hover:bg-red-600 shadow-lg shadow-brand/20 transition-colors uppercase tracking-widest">GUARDAR</button>
             </form>
        </div>
    </div>

    <!-- Modal Deuda Plazo (ACTUALIZADO CON FRECUENCIA) -->
    <div id="debt-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
            <div class="flex justify-between items-center mb-6 border-b border-border pb-4">
                <h3 class="font-black text-text uppercase">Nueva Deuda a Plazo</h3>
                <button onclick="closeModal('debt-modal')" class="w-8 h-8 rounded-full bg-input-bg flex items-center justify-center text-text-mute hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
             </div>
             <form id="debt-form" onsubmit="saveDebt(event)" class="space-y-4">
                 <div>
                      <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Concepto (ej. iPhone)</label>
                      <input type="text" id="debt-title" class="input-gp" required>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Monto Total</label>
                        <input type="number" id="debt-amount" step="0.01" class="input-gp" placeholder="0.00" required>
                      </div>
                      <div>
                        <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Plazos</label>
                        <div class="flex gap-2">
                             <input type="number" id="debt-installments" class="input-gp" placeholder="12" required>
                             <select id="debt-frequency" class="input-gp w-auto px-2 bg-input-bg text-xs">
                                <option value="monthly">Mes</option>
                                <option value="biweekly">Qna</option>
                             </select>
                        </div>
                      </div>
                 </div>
                 <button type="submit" class="w-full bg-brand text-white py-3 rounded-xl font-bold text-xs hover:bg-red-600 shadow-lg shadow-brand/20 transition-colors uppercase tracking-widest">GUARDAR</button>
                 <button type="button" id="btn-delete-debt" class="w-full py-2 text-alert font-bold text-xs uppercase hidden" onclick="deleteDebt()">Eliminar Deuda</button>
             </form>
        </div>
    </div>

    <!-- Modal Préstamos -->
    <div id="loans-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
            <div class="flex justify-between items-center mb-6 border-b border-border pb-4">
                <h3 class="font-black text-text uppercase" id="loan-modal-title">Nuevo Préstamo</h3>
                <button onclick="closeModal('loans-modal')" class="w-8 h-8 rounded-full bg-input-bg flex items-center justify-center text-text-mute hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
            </div>
            <form onsubmit="saveLoan(event)" class="space-y-4">
                <div class="flex bg-input-bg rounded-xl p-1 border border-border">
                    <button type="button" onclick="setLoanType('lent')" id="btn-lent" class="flex-1 py-2 text-xs font-bold rounded-lg bg-card text-money transition-all shadow-sm">ME DEBEN</button>
                    <button type="button" onclick="setLoanType('borrowed')" id="btn-borrowed" class="flex-1 py-2 text-xs font-bold text-text-mute transition-all">DEBO</button>
                </div>
                <input type="hidden" id="loan-type" value="lent">
                
                <div>
                      <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Persona</label>
                      <input type="text" id="loan-person" class="input-gp" required>
                 </div>
                 <div>
                    <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Monto</label>
                    <input type="number" id="loan-amount" step="0.01" class="input-gp" required>
                 </div>
                 <div>
                    <label class="text-[10px] uppercase font-bold text-text-mute block mb-1">Fecha Límite/Registro</label>
                    <input type="date" id="loan-date" class="input-gp bg-input-bg" required>
                </div>
                <button type="submit" id="btn-save-loan" class="w-full bg-brand text-white py-3 rounded-xl font-bold text-xs hover:bg-red-600 shadow-lg shadow-brand/20 transition-colors uppercase tracking-widest">GUARDAR</button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full shadow-[0_10px_30px_rgba(255,255,255,0.2)] z-[2000] opacity-0 pointer-events-none font-bold text-xs flex items-center gap-2">
        <i class="ph-bold ph-check-circle text-lg text-brand"></i>
        <span id="toast-msg">Mensaje</span>
    </div>

    <!-- LOGICA JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-cUzYmh5G9y_W2RXbO1Uma4DlKKmnnss",
            authDomain: "odsplan-adherencia.firebaseapp.com",
            projectId: "godsplan-adherencia",
            storageBucket: "godsplan-adherencia.firebasestorage.app",
            messagingSenderId: "660801277434",
            appId: "1:660801277434:web:3a37ece56538dc2b22a843"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let listeners = [];
        let editingTransactionId = null;
        let editingLoanId = null; 
        let editingDebtId = null;

        window.appData = {
            transactions: [],
            fixed: [],
            loans: [], 
            debts: [],
            settings: { frequency: 'biweekly', payday: null, savingsPercentage: 0, simulationMode: false }
        };

        // --- AUTH ---
        window.authApp = {
            isRegistering: false,
            toggleAuth(mode) {
                this.isRegistering = (mode === 'register');
                const nameField = document.getElementById('field-name');
                const btnLogin = document.getElementById('tab-login');
                const btnReg = document.getElementById('tab-register');
                const switcher = document.getElementById('auth-switcher-container');
                
                document.getElementById('auth-error-msg').classList.add('hidden');
                document.getElementById('btn-text').textContent = this.isRegistering ? "CREAR CUENTA" : "INICIAR SESIÓN";
                
                if (this.isRegistering) {
                    nameField.classList.remove('hidden');
                    switcher.classList.add('auth-mode-register');
                    btnReg.classList.add('active');
                    btnLogin.classList.remove('active');
                } else {
                    nameField.classList.add('hidden');
                    switcher.classList.remove('auth-mode-register');
                    btnLogin.classList.add('active');
                    btnReg.classList.remove('active');
                }
            },
            async handleAuthSubmit() {
                const btn = document.getElementById('btn-submit');
                const id = document.getElementById('input-id').value.trim();
                const pass = document.getElementById('input-pass').value;
                const name = document.getElementById('input-name').value.trim();
                
                if (!id || !pass) return this.showError("Faltan datos");
                if (this.isRegistering && !name) return this.showError("Nombre requerido");
                
                const finalId = id.includes('@') ? id : `${id}@godsplan.site`;
                btn.disabled = true;
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';

                try {
                    if (this.isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, finalId, pass);
                        await updateProfile(cred.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, finalId, pass);
                    }
                } catch (error) {
                    this.showError("Credenciales inválidas");
                    btn.disabled = false;
                    btn.innerHTML = '<span id="btn-text">REINTENTAR</span>';
                }
            },
            showError(msg) {
                document.getElementById('auth-error-txt').textContent = msg;
                document.getElementById('auth-error-msg').classList.remove('hidden');
            },
            logout() {
                if(confirm('¿Cerrar sesión?')) signOut(auth);
            }
        };

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) {}
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                document.getElementById('global-nav').classList.remove('hidden');
                document.getElementById('global-nav').classList.add('flex');
                document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.add('grid');
                
                document.getElementById('user-display-name').textContent = user.displayName || 'Usuario';
                document.getElementById('user-display-email').textContent = user.email;

                document.getElementById('loading-screen').classList.add('hidden');
                setupListeners(user.uid);
            } else {
                currentUser = null;
                document.getElementById('main-container').classList.add('hidden');
                document.getElementById('global-nav').classList.add('hidden');
                document.getElementById('global-nav').classList.remove('flex');
                document.getElementById('bottom-nav').classList.add('hidden');
                document.getElementById('bottom-nav').classList.remove('grid');
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
            }
        });

        function setupListeners(userId) {
            listeners.forEach(u => u()); listeners = [];
            
            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'transactions'), (snap) => {
                window.appData.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDashboard(); renderHistory(); renderFixed();
            }));

            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'fixed'), (snap) => {
                window.appData.fixed = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFixed(); renderDashboard();
            }));

            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'loans'), (snap) => {
                window.appData.loans = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderLoans(); renderDashboard();
            }));

             listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'debts'), (snap) => {
                window.appData.debts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDebts(); renderDashboard();
            }));

            listeners.push(onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), (snap) => {
                if(snap.exists()) window.appData.settings = { ...window.appData.settings, ...snap.data() };
                setupSettingsUI(); renderDashboard();
            }));
        }

        // --- FUNCIONES GLOBAL ---
        window.openAddModal = function(type, fixedId = null) {
            editingTransactionId = null;
            document.getElementById('modal-tx-title').textContent = type === 'expense' ? "Nuevo Gasto" : "Nuevo Ingreso";
            document.getElementById('btn-save-tx').textContent = "GUARDAR";
            document.getElementById('btn-delete-tx').classList.add('hidden');
            document.getElementById('btn-save-tx').classList.add('col-span-2');
            document.getElementById('transaction-form').reset();
            
            const now = new Date();
            const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('t-date').value = localIso;
            
            document.getElementById(type === 'expense' ? 'radio-expense' : 'radio-income').checked = true;
            document.getElementById('t-fixed-id').value = fixedId || ''; 
            
            renderCategoryChips(type);
            openModal('transaction-modal');
        };

        window.addTransaction = async function(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const type = document.querySelector('input[name="type"]:checked').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const title = document.getElementById('t-title').value || (type === 'expense' ? 'Gasto' : 'Ingreso');
            const category = document.getElementById('t-category').value || 'General';
            const date = document.getElementById('t-date').value; 
            const fixedPaymentId = document.getElementById('t-fixed-id').value;

            const txData = { type, amount, title, category, date, createdAt: new Date().toISOString() };
            if(fixedPaymentId) txData.fixedPaymentId = fixedPaymentId;

            try {
                if (editingTransactionId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', editingTransactionId), txData);
                    showToast('Actualizado');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), txData);
                    showToast('Guardado');
                }
                closeModal('transaction-modal');
            } catch(e) { console.error(e); }
        };

        window.deleteCurrentTransaction = async function() {
            if(!editingTransactionId) return;
            if(confirm('¿Eliminar permanentemente?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', editingTransactionId));
                showToast('Eliminado');
                closeModal('transaction-modal');
            }
        }

        window.editTransaction = function(id) {
            const tx = window.appData.transactions.find(t => t.id === id);
            if(!tx) return;
            editingTransactionId = id;
            document.getElementById('modal-tx-title').textContent = "Editar Movimiento";
            document.getElementById('btn-save-tx').textContent = "ACTUALIZAR";
            document.getElementById('btn-delete-tx').classList.remove('hidden');
            document.getElementById('btn-save-tx').classList.remove('col-span-2');
            
            document.getElementById('t-amount').value = tx.amount;
            document.getElementById('t-title').value = tx.title;
            
            let dateVal = tx.date;
            if (dateVal && dateVal.length === 10) dateVal += "T12:00";
            document.getElementById('t-date').value = dateVal;
            
            document.getElementById(tx.type === 'expense' ? 'radio-expense' : 'radio-income').checked = true;
            document.getElementById('t-fixed-id').value = tx.fixedPaymentId || '';
            
            renderCategoryChips(tx.type);
            selectChip(tx.category);
            openModal('transaction-modal');
        };

        window.addFixed = async function(e) {
            e.preventDefault();
            const title = document.getElementById('f-title').value;
            const amount = parseFloat(document.getElementById('f-amount').value);
            const day = document.getElementById('f-day').value;
            const include = document.getElementById('f-include').checked;
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed'), { 
                title, amount, day, ignoreBudget: !include 
            });
            closeModal('fixed-modal');
            showToast('Guardado');
        };

        window.payFixed = function(id) {
            const f = window.appData.fixed.find(x => x.id === id);
            window.openAddModal('expense', id); 
            document.getElementById('t-amount').value = f.amount;
            document.getElementById('t-title').value = f.title;
            selectChip('Servicios');
        };

        window.deleteFixed = async function(id) {
            if(confirm('¿Borrar?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', id));
        };
        
        window.toggleFixedIgnore = async function(id, current) {
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', id), { ignoreBudget: !current });
        };

        // --- LÓGICA DEUDAS A PLAZOS ---

        window.openDebtModal = function(id = null) {
            editingDebtId = id;
            if (id) {
                const d = window.appData.debts.find(x => x.id === id);
                document.getElementById('debt-title').value = d.title;
                document.getElementById('debt-amount').value = d.totalAmount;
                document.getElementById('debt-installments').value = d.installments || d.months; 
                document.getElementById('debt-frequency').value = d.frequency || 'monthly';
                document.getElementById('btn-delete-debt').classList.remove('hidden');
            } else {
                document.getElementById('debt-form').reset();
                document.getElementById('debt-frequency').value = 'monthly';
                document.getElementById('btn-delete-debt').classList.add('hidden');
            }
            openModal('debt-modal');
        };

        window.saveDebt = async function(e) {
            e.preventDefault();
            const title = document.getElementById('debt-title').value;
            const totalAmount = parseFloat(document.getElementById('debt-amount').value);
            const installments = parseInt(document.getElementById('debt-installments').value);
            const frequency = document.getElementById('debt-frequency').value;
            
            const months = installments; 
            
            if (editingDebtId) {
                const old = window.appData.debts.find(x => x.id === editingDebtId);
                let newPayments = old.payments;
                const oldInstallments = old.installments || old.months;
                
                if (installments !== oldInstallments) {
                    newPayments = new Array(installments).fill(false);
                }
                
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'debts', editingDebtId), {
                    title, totalAmount, installments, months, frequency, payments: newPayments
                });
            } else {
                const payments = new Array(installments).fill(false);
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'debts'), {
                    title, totalAmount, installments, months, frequency, payments, createdAt: new Date().toISOString()
                });
            }
            closeModal('debt-modal');
            showToast('Deuda Guardada');
        };

        window.deleteDebt = async function() {
            if(!editingDebtId) return;
            if(confirm('¿Eliminar esta deuda?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'debts', editingDebtId));
                closeModal('debt-modal');
                showToast('Deuda Eliminada');
            }
        };

        window.toggleDebtPayment = async function(debtId, index) {
            const debt = window.appData.debts.find(d => d.id === debtId);
            if (!debt) return;
            
            const newPayments = [...debt.payments];
            newPayments[index] = !newPayments[index]; // Toggle status
            
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'debts', debtId), {
                payments: newPayments
            });
        };

        function renderDebts() {
            const container = document.getElementById('debts-list');
            if (window.appData.debts.length === 0) {
                container.innerHTML = '<div class="text-center text-text-mute text-xs italic py-4">No tienes deudas registradas</div>';
                return;
            }

            container.innerHTML = window.appData.debts.map(d => {
                const numPlazos = d.installments || d.months;
                const freq = d.frequency || 'monthly';
                const freqLabel = freq === 'monthly' ? '/mes' : '/qna';
                
                const installmentAmount = d.totalAmount / numPlazos;
                const paidCount = d.payments.filter(Boolean).length;
                const paidAmount = paidCount * installmentAmount;
                const remaining = d.totalAmount - paidAmount;
                const progress = Math.round((paidCount / numPlazos) * 100);

                let bubblesHTML = '';
                for(let i=0; i < numPlazos; i++) {
                    const isPaid = d.payments[i];
                    bubblesHTML += `<div onclick="event.stopPropagation(); toggleDebtPayment('${d.id}', ${i})" class="debt-bubble ${isPaid ? 'paid' : ''}">${i + 1}</div>`;
                }

                return `
                <div class="bg-card border border-border p-4 rounded-2xl relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-4" onclick="openDebtModal('${d.id}')">
                        <div>
                            <h3 class="font-bold text-text uppercase tracking-wide cursor-pointer hover:text-brand transition-colors">${d.title}</h3>
                            <p class="text-[10px] text-text-mute font-medium">Pago sugerido: ${formatCurrency(installmentAmount)}${freqLabel}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-brand text-lg tracking-tight">${formatCurrency(remaining)}</p>
                             <p class="text-[10px] text-text-mute font-bold">Restante</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${bubblesHTML}
                    </div>
                    
                    <div class="w-full bg-input-bg h-1 rounded-full mt-2 overflow-hidden">
                        <div class="bg-brand h-full transition-all duration-500" style="width: ${progress}%"></div>
                    </div>
                </div>
                `;
            }).join('');
        }


        // --- FIN LOGICA DEUDAS ---


        window.openLoanModal = function() {
            editingLoanId = null; // Resetear edición
            document.getElementById('loan-modal-title').textContent = "Nuevo Préstamo";
            document.getElementById('btn-save-loan').textContent = "GUARDAR";
            
            document.getElementById('loan-person').value = '';
            document.getElementById('loan-amount').value = '';
            document.getElementById('loan-date').value = new Date().toISOString().split('T')[0];
            setLoanType('lent');
            openModal('loans-modal');
        };

        window.editLoan = function(id) {
            const l = window.appData.loans.find(x => x.id === id);
            if(!l) return;
            
            editingLoanId = id;
            document.getElementById('loan-modal-title').textContent = "Editar Préstamo";
            document.getElementById('btn-save-loan').textContent = "ACTUALIZAR";
            
            document.getElementById('loan-person').value = l.person;
            document.getElementById('loan-amount').value = l.amount;
            document.getElementById('loan-date').value = l.date;
            setLoanType(l.type);
            
            openModal('loans-modal');
        };

        window.setLoanType = function(type) {
            const btnLent = document.getElementById('btn-lent');
            const btnBorrowed = document.getElementById('btn-borrowed');
            document.getElementById('loan-type').value = type;

            if (type === 'lent') {
                btnLent.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-card text-money transition-all shadow-sm";
                btnBorrowed.className = "flex-1 py-2 text-xs font-bold text-text-mute transition-all";
            } else {
                btnBorrowed.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-card text-brand transition-all shadow-sm";
                btnLent.className = "flex-1 py-2 text-xs font-bold text-text-mute transition-all";
            }
        };

        window.saveLoan = async function(e) {
            e.preventDefault();
            const type = document.getElementById('loan-type').value;
            const person = document.getElementById('loan-person').value;
            const amount = parseFloat(document.getElementById('loan-amount').value);
            const date = document.getElementById('loan-date').value;

            const loanData = { type, person, amount, date };

            try {
                if (editingLoanId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'loans', editingLoanId), loanData);
                    showToast('Actualizado');
                } else {
                    loanData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'loans'), loanData);
                    showToast('Guardado');
                }
                closeModal('loans-modal');
            } catch(e) { console.error(e); }
        };

        window.deleteLoan = async function(id) {
             if(confirm('¿Borrar?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'loans', id));
                showToast('Eliminado');
                // Si estaba abierto el modal en modo edición para este ID, cerrarlo
                if(editingLoanId === id) closeModal('loans-modal');
             }
        };

        window.saveSettings = async function() {
            const freq = document.querySelector('input[name="pay-freq"]:checked').value;
            const payday = document.getElementById('payday-select').value;
            const payday1 = document.getElementById('payday-1-select').value;
            const payday2 = document.getElementById('payday-2-select').value;
            // Nuevo: porcentaje de ahorro (0, 5, 10, 15)
            const savingsPercentage = document.getElementById('savings-percent').value;
            const simulationMode = document.getElementById('toggle-simulation').checked;
            
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), { 
                frequency: freq, payday, payday1, payday2, savingsPercentage: parseInt(savingsPercentage), simulationMode
            }, { merge: true });
            showToast('Guardado');
        };

        window.resetApp = async function() {
            if(confirm('¿ESTÁS SEGURO? ESTO BORRARÁ TODO PERMANENTEMENTE.')) {
                const txs = window.appData.transactions;
                const fxs = window.appData.fixed;
                const loans = window.appData.loans;
                const debts = window.appData.debts;
                
                txs.forEach(t => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', t.id)));
                fxs.forEach(f => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', f.id)));
                loans.forEach(l => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'loans', l.id)));
                debts.forEach(d => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'debts', d.id)));
                
                showToast('Reseteado');
            }
        };
        
        window.openAdjustModal = function() {
            let balCents = 0;
            window.appData.transactions.forEach(t => {
                const amountCents = Math.round(t.amount * 100);
                if (t.type === 'income') balCents += amountCents;
                else balCents -= amountCents;
            });
            const bal = balCents / 100;
            document.getElementById('adjust-current-display').textContent = formatCurrency(bal);
            document.getElementById('adjust-current-display').dataset.raw = bal;
            document.getElementById('adjust-amount').value = '';
            openModal('adjust-modal');
        }

        window.submitAdjustment = async function(e) {
            e.preventDefault();
            const real = parseFloat(document.getElementById('adjust-amount').value);
            const sys = parseFloat(document.getElementById('adjust-current-display').dataset.raw);
            const diff = (Math.round(real * 100) - Math.round(sys * 100)) / 100;
            
            if(Math.abs(diff) < 0.01) return closeModal('adjust-modal');
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), {
                type: diff > 0 ? 'income' : 'expense',
                amount: Math.abs(diff),
                title: 'Ajuste Manual de Saldo',
                category: 'Ajuste',
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            });
            closeModal('adjust-modal');
            showToast('Ajustado');
        }

        window.exportData = function() {
            const data = { transactions: window.appData.transactions, fixed: window.appData.fixed, loans: window.appData.loans, debts: window.appData.debts, settings: window.appData.settings };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "godsplan_backup.json"; a.click();
        }

        window.importData = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const json = JSON.parse(e.target.result);
                if(json.transactions) json.transactions.forEach(t => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), t));
                if(json.fixed) json.fixed.forEach(f => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed'), f));
                if(json.loans) json.loans.forEach(l => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'loans'), l));
                if(json.debts) json.debts.forEach(d => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'debts'), d));
                showToast('Datos Importados');
            };
            reader.readAsText(file);
        }

        initAuth();
    </script>

    <script>
        let currentViewDate = new Date();
        
        const COMMON_HOLIDAYS = ['01-01', '02-05', '03-21', '05-01', '09-16', '11-20', '12-25'];

        const CATEGORIES = {
            expense: [
                { id: 'Comida', icon: 'ph-hamburger' },
                { id: 'Transporte', icon: 'ph-car' },
                { id: 'Hogar', icon: 'ph-house' },
                { id: 'Ocio', icon: 'ph-film-strip' },
                { id: 'Salud', icon: 'ph-heartbeat' },
                { id: 'Servicios', icon: 'ph-lightning' },
                { id: 'Educación', icon: 'ph-graduation-cap' },
                { id: 'Ropa', icon: 'ph-t-shirt' },
                { id: 'Otros', icon: 'ph-dots-three-circle' },
                { id: 'Ajuste', icon: 'ph-scales' }
            ],
            income: [
                { id: 'Nómina', icon: 'ph-money' },
                { id: 'Venta', icon: 'ph-tag' },
                { id: 'Regalo', icon: 'ph-gift' },
                { id: 'Freelance', icon: 'ph-laptop' },
                { id: 'Ajuste', icon: 'ph-scales' },
                { id: 'Otro', icon: 'ph-dots-three-circle' }
            ]
        };

        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        
        function updateDateHeader() {
            const str = currentViewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('current-date-header').textContent = str.charAt(0).toUpperCase() + str.slice(1);
        }

        function isFixedPaidThisMonth(fixedId) {
            const now = new Date();
            const m = now.getMonth();
            const y = now.getFullYear();
            return window.appData.transactions.some(t => {
                if (!t.date) return false;
                const d = new Date(t.date);
                if (isNaN(d.getTime())) return false; 
                return t.fixedPaymentId === fixedId && d.getMonth() === m && d.getFullYear() === y;
            });
        }

        function renderDashboard() {
            if (!window.appData || !window.appData.transactions) return;
            
            const m = currentViewDate.getMonth();
            const y = currentViewDate.getFullYear();
            
            const monthlyTx = window.appData.transactions.filter(t => {
                if (!t.date) return false;
                const d = new Date(t.date);
                if(isNaN(d.getTime())) return false;
                return d.getMonth() === m && d.getFullYear() === y;
            });

            let incMCents = 0, expMCents = 0;
            monthlyTx.forEach(t => {
                const val = Math.round(t.amount * 100);
                if (t.type === 'income') incMCents += val;
                else expMCents += val;
            });
            const incM = incMCents / 100;
            const expM = expMCents / 100;
            
            let incTCents = 0, expTCents = 0;
            window.appData.transactions.forEach(t => {
                 const val = Math.round(t.amount * 100);
                 if (t.type === 'income') incTCents += val;
                 else expTCents += val;
            });
            
            const totalBalanceReal = (incTCents - expTCents) / 100;

            const showInc = incM;
            const showExp = expM;
            
            // --- APLICAR PORCENTAJE DE AHORRO AL BALANCE VISIBLE ---
            const savingsPct = parseInt(window.appData.settings.savingsPercentage) || 0;
            let displayBalance = totalBalanceReal; 

            if (savingsPct > 0) {
                // Descontar porcentaje
                displayBalance = displayBalance * (1 - (savingsPct / 100));
                document.getElementById('savings-active-icon').classList.remove('hidden');
            } else {
                document.getElementById('savings-active-icon').classList.add('hidden');
            }

            document.getElementById('total-balance').textContent = formatCurrency(displayBalance);
            document.getElementById('total-income').textContent = formatCurrency(showInc);
            document.getElementById('total-expense').textContent = formatCurrency(showExp);

            const totalMonthlyIncome = incM;
            const totalMonthlyExpense = expM;
            
            let percent = 0;
            if (totalMonthlyIncome > 0) {
                 percent = Math.min((totalMonthlyExpense / totalMonthlyIncome) * 100, 100);
            } else if (totalMonthlyExpense > 0) {
                percent = 100;
            }
            
            document.getElementById('balance-progress').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;
            
            const bar = document.getElementById('balance-progress');
            bar.className = `h-full w-0 transition-all duration-700 ease-out shadow-[0_0_15px_rgba(255,255,255,0.8)] ${percent > 90 ? 'bg-alert' : (percent > 60 ? 'bg-yellow-400' : 'bg-white')}`;

            // --- ACTUALIZAR RESUMEN FINANCIERO (Dashboard) ---
            let totalDebtRemaining = 0;
            window.appData.debts.forEach(d => {
                const numPlazos = d.installments || d.months;
                const paidCount = d.payments.filter(Boolean).length;
                const installmentAmount = d.totalAmount / numPlazos;
                totalDebtRemaining += (d.totalAmount - (paidCount * installmentAmount));
            });
            document.getElementById('dashboard-total-debt').textContent = formatCurrency(totalDebtRemaining);

            let loansNet = 0;
            window.appData.loans.forEach(l => {
                const amt = parseFloat(l.amount);
                if(l.type === 'lent') loansNet += amt;
                else loansNet -= amt;
            });
            const lnEl = document.getElementById('dashboard-loans-net');
            lnEl.textContent = formatCurrency(loansNet);
            if(loansNet < 0) lnEl.classList.add('text-brand');
            else lnEl.classList.remove('text-brand');
            // ------------------------------------------------

            const listEl = document.getElementById('recent-list');
            const displayTx = monthlyTx;
            
            displayTx.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(displayTx.length === 0) {
                listEl.innerHTML = '<div class="text-center text-text-mute text-xs py-4 italic font-medium">Sin movimientos este mes</div>';
            } else {
                const listHTML = displayTx.slice(0, 5).map(t => createTxHTML(t)).join('');
                listEl.innerHTML = listHTML;
            }
            
            // IMPORTANTE: Pasamos el displayBalance (el que ya tiene el ahorro descontado)
            // para que la fórmula del día calcule en base a lo "seguro" para gastar.
            updatePaydayInfo(displayBalance);

            const simContainer = document.getElementById('simulation-container');
            if (window.appData.settings.simulationMode) {
                simContainer.classList.remove('hidden');
            } else {
                simContainer.classList.add('hidden');
            }
        }

        function createTxHTML(t) {
            const isInc = t.type === 'income';
            const catObj = [...CATEGORIES.expense, ...CATEGORIES.income].find(c => c.id === t.category);
            const icon = catObj ? catObj.icon : 'ph-circle';
            
            let dateDisplay = '';
            if (t.date) {
                const d = new Date(t.date);
                if (!isNaN(d.getTime())) {
                        dateDisplay = d.getDate() + '/' + (d.getMonth()+1);
                }
            }
            
            let amountClass = isInc ? 'text-money bg-emerald-900/20' : 'text-text bg-white/5';
            let iconClass = isInc ? 'bg-green-900/20 text-money' : 'bg-input-bg text-text-mute';

            return `
            <div class="flex justify-between items-center p-3 rounded-xl bg-card border border-border hover:bg-input-bg cursor-pointer transition-all group shadow-sm" onclick="editTransaction('${t.id}')">
                <div class="flex items-center gap-3 overflow-hidden flex-1">
                    <div class="w-10 h-10 rounded-xl ${iconClass} flex items-center justify-center border border-border group-hover:border-brand/50 group-hover:text-text transition-colors shrink-0">
                        <i class="ph-fill ${icon} text-lg"></i>
                    </div>
                    <div class="min-w-0">
                        <h4 class="font-bold text-text text-xs truncate group-hover:text-white transition-colors uppercase tracking-wide">${t.title}</h4>
                        <p class="text-[10px] text-text-mute uppercase font-bold truncate">
                            ${t.category} • ${dateDisplay}
                        </p>
                    </div>
                </div>
                <span class="font-black text-xs ${amountClass} px-2 py-1 rounded-lg ml-2">
                    ${isInc ? '+' : '-'}${formatCurrency(t.amount)}
                </span>
            </div>
            `;
        }

        function renderHistory() {
            const activeBtn = document.querySelector('.filter-btn.active');
            const filter = activeBtn ? activeBtn.dataset.filter : 'all';
            
            const list = document.getElementById('full-history-list');
            // Mantener la línea de tiempo
            list.innerHTML = '<div class="timeline-line"></div>';
            
            let txs = [...window.appData.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filter !== 'all') txs = txs.filter(t => t.type === filter);
            
            if(txs.length === 0) {
                list.innerHTML += '<div class="text-center text-text-mute py-8 text-xs flex flex-col items-center gap-2"><i class="ph-bold ph-ghost text-2xl"></i><span class="font-medium">Sin registros aún</span></div>';
                return;
            }

            const grouped = {};
            txs.forEach(t => {
                if(!t.date) return;
                const dateKey = t.date.substring(0, 10);
                if(!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                const groupDiv = document.createElement('div');
                const dateObj = new Date(date + 'T00:00:00');
                
                const today = new Date(); today.setHours(0,0,0,0);
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
                
                let label = dateObj.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                if(dateObj.getTime() === today.getTime()) label = "Hoy";
                else if(dateObj.getTime() === yesterday.getTime()) label = "Ayer";
                label = label.toUpperCase();

                const txItemsHTML = grouped[date].map(t => {
                    const isInc = t.type === 'income';
                    const catObj = [...CATEGORIES.expense, ...CATEGORIES.income].find(c => c.id === t.category);
                    const icon = catObj ? catObj.icon : 'ph-circle';
                    
                    return `
                    <div class="timeline-item group cursor-pointer" onclick="editTransaction('${t.id}')">
                        <div class="timeline-dot ${t.type}"></div>
                        <div class="flex justify-between items-start pr-2">
                            <div>
                                <h4 class="text-sm font-bold text-text group-hover:text-white transition-colors">${t.title}</h4>
                                <p class="text-[10px] text-text-mute font-medium uppercase">${t.category}</p>
                            </div>
                            <span class="font-bold text-xs ${isInc ? 'text-money' : 'text-text'}">
                                ${isInc ? '+' : '-'}${formatCurrency(t.amount)}
                            </span>
                        </div>
                    </div>
                    `;
                }).join('');
                
                groupDiv.innerHTML = `
                    <div class="mb-6 relative">
                         <span class="sticky-date bg-input-bg border border-border px-3 py-1 text-[10px] font-black uppercase text-text-mute mb-4 ml-1 shadow-sm">
                            ${label}
                         </span>
                         <div class="mt-4">
                            ${txItemsHTML}
                         </div>
                    </div>
                `;
                list.appendChild(groupDiv);
            });
        }

        function renderFixed() {
            const container = document.getElementById('fixed-container');
            if(window.appData.fixed.length === 0) {
                container.innerHTML = '<div class="text-center text-text-mute py-4 col-span-full text-xs italic font-medium">No has configurado pagos fijos</div>';
                return;
            }

            const sortedFixed = [...window.appData.fixed].sort((a,b) => parseInt(a.day) - parseInt(b.day));
            
            // Separar en Q1 y Q2
            const q1 = sortedFixed.filter(f => parseInt(f.day) <= 15);
            const q2 = sortedFixed.filter(f => parseInt(f.day) > 15);

            const renderGroup = (items, title) => {
                if (items.length === 0) return '';
                const itemsHtml = items.map(f => {
                    const isPaid = isFixedPaidThisMonth(f.id);
                    const isIgnored = f.ignoreBudget;
                    
                    const bgClass = isPaid ? "bg-emerald-900/10 border-emerald-900/30" : "bg-card border-border";
                    const textClass = isPaid ? "text-money" : (isIgnored ? "text-text-mute line-through" : "text-text");
                    const eyeIcon = isIgnored ? 'ph-eye-slash' : 'ph-eye';
                    const eyeColor = isIgnored ? 'text-text-mute' : 'text-blue-500';
                    const actionBtn = isPaid 
                        ? `<div class="w-8 h-8 rounded-lg flex items-center justify-center text-money bg-emerald-900/20"><i class="ph-bold ph-check-circle text-xl"></i></div>`
                        : `<button onclick="payFixed('${f.id}')" class="w-8 h-8 rounded-lg bg-input-bg flex items-center justify-center text-text-mute hover:text-white hover:bg-white/10 transition-all border border-border"><i class="ph-bold ph-check"></i></button>`;

                    return `
                    <div class="${bgClass} border p-3 rounded-xl flex justify-between items-center transition-all shadow-sm">
                        <div>
                            <p class="font-bold ${textClass} text-xs mb-0.5 uppercase tracking-wide">${f.title}</p>
                            <p class="text-[10px] text-text-mute font-bold uppercase flex items-center gap-1">
                                 <i class="ph-bold ph-calendar-blank"></i> Día ${f.day} • ${formatCurrency(f.amount)}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleFixedIgnore('${f.id}', ${!!isIgnored})" class="w-8 h-8 rounded-lg flex items-center justify-center ${eyeColor} hover:bg-white/5 transition-colors"><i class="ph-bold ${eyeIcon}"></i></button>
                            ${actionBtn}
                            <button onclick="deleteFixed('${f.id}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-text-mute hover:text-alert hover:bg-alert/10 transition-colors"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                    `;
                }).join('');

                return `
                    <div>
                        <h4 class="text-[10px] font-black text-text-mute uppercase mb-2 tracking-widest pl-1 border-l-2 border-brand/50">${title}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            };

            container.innerHTML = renderGroup(q1, '1ra Quincena (1-15)') + renderGroup(q2, '2da Quincena (16-31)');
        }

        function renderLoans() {
            const list = document.getElementById('loans-list');
            const loans = window.appData.loans || [];

            let owedToMe = 0;
            let iOwe = 0;

            loans.forEach(l => {
                const val = parseFloat(l.amount) || 0;
                if(l.type === 'lent') owedToMe += val;
                else iOwe += val;
            });

            document.getElementById('loans-owed-to-me').textContent = formatCurrency(owedToMe);
            document.getElementById('loans-i-owe').textContent = formatCurrency(iOwe);

            if(loans.length === 0) {
                list.innerHTML = '<div class="text-center text-text-mute py-4 col-span-full text-xs italic font-medium">Sin préstamos activos</div>';
                return;
            }

            const html = loans.map(l => {
                const isLent = l.type === 'lent'; 
                const icon = isLent ? 'ph-arrow-up-right' : 'ph-arrow-down-left';
                const color = isLent ? 'text-money' : 'text-brand';
                const bgIcon = isLent ? 'bg-emerald-900/20' : 'bg-red-900/20';

                return `
                <div class="bg-card border border-border p-3 rounded-xl flex justify-between items-center shadow-sm cursor-pointer hover:bg-input-bg transition-colors group" onclick="editLoan('${l.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg ${bgIcon} flex items-center justify-center ${color} shrink-0 border border-border group-hover:border-white/20 transition-colors">
                            <i class="ph-bold ${icon} text-lg"></i>
                        </div>
                        <div>
                            <p class="font-bold text-text text-xs uppercase tracking-wide group-hover:text-white transition-colors">${l.person}</p>
                            <p class="text-[10px] text-text-mute font-bold uppercase">${l.date}</p>
                        </div>
                    </div>
                      <div class="flex items-center gap-3">
                        <p class="font-black ${color} text-xs">${formatCurrency(l.amount)}</p>
                        <button onclick="event.stopPropagation(); deleteLoan('${l.id}')" class="text-text-mute hover:text-alert transition-colors p-1"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
                `;
            }).join('');

            list.innerHTML = html;
        }

        function getPendingFixedAmount(targetDate) {
            let pending = 0;
            let cursor = new Date();
            cursor.setHours(0,0,0,0);
            cursor.setDate(cursor.getDate() + 1); 

            const end = new Date(targetDate);
            end.setHours(0,0,0,0);

            while (cursor <= end) {
                const dayNum = cursor.getDate();
                const isCurrentMonth = (cursor.getMonth() === new Date().getMonth() && cursor.getFullYear() === new Date().getFullYear());

                window.appData.fixed.forEach(f => {
                    if (f.ignoreBudget) return;
                    
                    if (parseInt(f.day) === dayNum) {
                        if (isCurrentMonth && isFixedPaidThisMonth(f.id)) {
                            return; 
                        }
                        pending += parseFloat(f.amount);
                    }
                });

                cursor.setDate(cursor.getDate() + 1);
            }
            return pending;
        }

        function updatePaydayInfo(currentDisplayBalance) {
            // currentDisplayBalance = El saldo ya con el ahorro descontado.
            const set = window.appData.settings;
            const badge = document.getElementById('payday-badge');
            
            const daysLabel = document.getElementById('formula-days-left');
            const dailyLabel = document.getElementById('formula-daily');
            const explanation = document.getElementById('formula-explanation');
            
            if(!set || (set.frequency === 'monthly' && !set.payday)) {
                badge.textContent = "Sin Config";
                daysLabel.textContent = "-";
                dailyLabel.textContent = "$0.00";
                explanation.textContent = "Ve a Ajustes para configurar tus fechas de cobro.";
                return;
            }
            
            const nextDate = getNextPayday();
            if (!nextDate) return;

            const today = new Date(); today.setHours(0,0,0,0);
            const diff = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
            
            badge.textContent = diff <= 0 ? "Hoy Cobras" : `${diff} Días`;
            
            updateDailyFormula(currentDisplayBalance, diff, nextDate);
        }

        function getNextPayday() {
            const today = new Date(); today.setHours(0,0,0,0);
            let candidates = [];
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const s = window.appData.settings;
            
            const getSafeDate = (year, month, day) => {
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                const safeDay = Math.min(day, lastDayOfMonth);
                return new Date(year, month, safeDay);
            };

            for(let m = 0; m <= 1; m++) {
                let monthIndex = currentMonth + m; 
                let year = currentYear;
                if(monthIndex > 11) { monthIndex -= 12; year++; }

                if (s.frequency === 'biweekly') {
                    candidates.push(getSafeDate(year, monthIndex, 15));
                    candidates.push(getSafeDate(year, monthIndex, 30)); 
                } else if (s.frequency === 'biweekly-custom' && s.payday1 && s.payday2) {
                    candidates.push(getSafeDate(year, monthIndex, parseInt(s.payday1)));
                    candidates.push(getSafeDate(year, monthIndex, parseInt(s.payday2)));
                } else if (s.frequency === 'monthly' && s.payday) {
                    candidates.push(getSafeDate(year, monthIndex, parseInt(s.payday)));
                }
            }
            
            let adjustedCandidates = candidates.map(d => getNextBusinessDay(d));
            adjustedCandidates.sort((a,b) => a - b);
            
            for (let d of adjustedCandidates) {
                d.setHours(0,0,0,0);
                if (d >= today) return d;
            }
            return adjustedCandidates[0]; 
        }

        function getNextBusinessDay(date) {
            let d = new Date(date);
            const fmt = (x) => `${(x.getMonth()+1).toString().padStart(2,'0')}-${x.getDate().toString().padStart(2,'0')}`;

            while (d.getDay() === 0 || d.getDay() === 6) {
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        function updateDailyFormula(currentBalance, daysLeft, nextPaydayDate) {
            // Nota: currentBalance es el saldo "Seguro" (Visible), ya sin el ahorro.
            
            let spentToday = 0;
            const todayDate = new Date();
            todayDate.setHours(0,0,0,0);
            
            window.appData.transactions.forEach(t => {
                if(t.type === 'expense' && t.date) {
                      const tDate = new Date(t.date);
                      tDate.setHours(0,0,0,0);
                      if(tDate.getTime() === todayDate.getTime()) {
                          spentToday += parseFloat(t.amount);
                      }
                }
            });

            const calcLimitDate = new Date(nextPaydayDate);
            calcLimitDate.setDate(calcLimitDate.getDate() - 1);
            
            const pendingFixedSum = getPendingFixedAmount(calcLimitDate);

            // Como currentBalance es lo que ME QUEDA, y spentToday es lo que GASTE,
            // Mi "Saldo Inicial del Día" en teoría era currentBalance + spentToday.
            // Pero currentBalance ya tiene el ahorro descontado.
            // Asi que el cálculo se hace sobre la base descontada.
            
            const startOfDayBalance = currentBalance + spentToday;
            const effectiveStartBalance = startOfDayBalance - pendingFixedSum;
            
            const divisor = daysLeft <= 0 ? 1 : daysLeft;
            
            let budgetForToday = effectiveStartBalance / divisor;
            const remainingToday = budgetForToday - spentToday;
            
            const explEl = document.getElementById('formula-explanation');

            explEl.innerHTML = `Base: <strong class="text-white">${formatCurrency(budgetForToday)}</strong> • Gastado: <strong class="text-text-mute">-${formatCurrency(spentToday)}</strong>`;
            
            const remainingEl = document.getElementById('formula-daily');
            remainingEl.textContent = formatCurrency(remainingToday);
            
            if(remainingToday < 0) remainingEl.classList.add('text-alert');
            else remainingEl.classList.remove('text-alert');

            document.getElementById('formula-days-left').textContent = `Fijos: -${formatCurrency(pendingFixedSum)}`;
        }

        function runSimulation() {
            const dateInput = document.getElementById('sim-date').value;
            const amountInput = parseFloat(document.getElementById('sim-amount').value);
            const resultEl = document.getElementById('sim-result');
            const detailsEl = document.getElementById('sim-details');
            
            if (!dateInput || isNaN(amountInput)) {
                resultEl.textContent = "$0.00";
                detailsEl.textContent = "Ingresa fecha y monto futuro.";
                return;
            }

            const futureDate = new Date(dateInput + 'T00:00:00'); 
            const today = new Date();
            today.setHours(0,0,0,0);

            const diffTime = futureDate - today;
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            if (diffDays <= 0) diffDays = 1; 

            let currentBalance = 0;
            window.appData.transactions.forEach(t => {
                const val = Math.round(t.amount * 100);
                if (t.type === 'income') currentBalance += val;
                else currentBalance -= val;
            });
            currentBalance = currentBalance / 100;

            const pendingFixed = getPendingFixedAmount(futureDate);

            const totalPool = currentBalance + amountInput - pendingFixed;
            const dailyBudget = totalPool / diffDays;

            resultEl.textContent = formatCurrency(dailyBudget);
            if(dailyBudget < 0) resultEl.classList.add('text-alert');
            else resultEl.classList.remove('text-alert');

            detailsEl.innerHTML = `
                Días: <strong>${diffDays}</strong><br>
                (Saldo: ${formatCurrency(currentBalance)} + Futuro: ${formatCurrency(amountInput)} - Fijos: ${formatCurrency(pendingFixed)}) / ${diffDays}
            `;
        }

        function switchTab(id) {
            // Ocultar todas las secciones
            document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            
            // Título dinámico
            const titles = {
                'dashboard': 'Finanzas',
                'history': 'Historial',
                'payments': 'Pagos y Deudas',
                'settings': 'Ajustes'
            };
            document.getElementById('current-view-title').textContent = titles[id] || 'Finanzas';

            // LOGICA PARA ACTUALIZAR NAVEGACION
            const tabs = ['dashboard', 'history', 'payments', 'settings'];
            
            tabs.forEach(tab => {
                // 1. Móvil
                const mBtn = document.getElementById(`nav-${tab}`);
                if(mBtn) {
                    if(tab === id) {
                        mBtn.classList.remove('text-text-mute');
                        mBtn.classList.add('text-white');
                    } else {
                        mBtn.classList.add('text-text-mute');
                        mBtn.classList.remove('text-white');
                    }
                }

                // 2. Desktop (IDs agregados: desktop-nav-dashboard, etc)
                const dBtn = document.getElementById(`desktop-nav-${tab}`);
                if(dBtn) {
                    if(tab === id) {
                        // Estado Activo
                        dBtn.classList.remove('text-text-mute', 'hover:text-white');
                        dBtn.classList.add('text-white', 'bg-bg', 'shadow-sm');
                    } else {
                        // Estado Inactivo
                        dBtn.classList.add('text-text-mute', 'hover:text-white');
                        dBtn.classList.remove('text-white', 'bg-bg', 'shadow-sm');
                    }
                }
            });

            // Renderizar contenido específico
            if(id === 'dashboard') renderDashboard();
            if(id === 'history') renderHistory();
            if(id === 'payments') { renderFixed(); renderLoans(); renderDebts(); }
        }

        function filterHistory(type) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.filter-btn[data-filter="${type}"]`).classList.add('active');
            renderHistory();
        }

        function renderCategoryChips(type) {
            const container = document.getElementById('category-chips');
            container.innerHTML = '';
            const list = type === 'expense' ? CATEGORIES.expense : CATEGORIES.income;
            
            list.forEach(c => {
                const div = document.createElement('div');
                div.className = "chip flex items-center gap-2";
                div.innerHTML = `<i class="ph-fill ${c.icon}"></i> ${c.id}`;
                div.onclick = () => selectChip(c.id);
                div.dataset.id = c.id;
                container.appendChild(div);
            });
        }

        function selectChip(catId) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            const selected = document.querySelector(`.chip[data-id="${catId}"]`);
            if(selected) selected.classList.add('active');
            document.getElementById('t-category').value = catId;
        }

        function setupSettingsUI() {
            if(!window.appData.settings) return;
            const s = window.appData.settings;
            const radios = document.getElementsByName('pay-freq');
            for(let r of radios) { if(r.value === s.frequency) r.checked = true; }
            
            const selPayday = document.getElementById('payday-select'); if(selPayday && s.payday) selPayday.value = s.payday;
            const selP1 = document.getElementById('payday-1-select'); if(selP1 && s.payday1) selP1.value = s.payday1;
            const selP2 = document.getElementById('payday-2-select'); if(selP2 && s.payday2) selP2.value = s.payday2;
            
            // NUEVO: SETUP DEL SELECTOR DE AHORRO
            const savingsSel = document.getElementById('savings-percent');
            if(savingsSel && s.savingsPercentage !== undefined) savingsSel.value = s.savingsPercentage;
            
            const toggleSim = document.getElementById('toggle-simulation');
            if(toggleSim && s.simulationMode !== undefined) toggleSim.checked = s.simulationMode;

            togglePaydayInput();
        }

        function togglePaydayInput() {
            const freq = document.querySelector('input[name="pay-freq"]:checked')?.value || 'biweekly';
            const mCont = document.getElementById('monthly-select-container');
            const bCont = document.getElementById('biweekly-custom-container');
            
            if (mCont) mCont.classList.add('hidden');
            if (bCont) bCont.classList.add('hidden');
            
            if (freq === 'monthly' && mCont) mCont.classList.remove('hidden');
            if (freq === 'biweekly-custom' && bCont) bCont.classList.remove('hidden');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('is-open');
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('is-open');
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            setTimeout(() => {
                 t.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sels = [document.getElementById('f-day'), document.getElementById('payday-select'), document.getElementById('payday-1-select'), document.getElementById('payday-2-select')];
            sels.forEach(s => {
                if(s) {
                    for(let i=1; i<=31; i++) s.innerHTML += `<option value="${i}">${i}</option>`;
                }
            });
            updateDateHeader();
        });

        // Exponer funciones globales
        window.switchTab = switchTab;
        window.filterHistory = filterHistory;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.togglePaydayInput = togglePaydayInput;
    </script>
</body>
</html>
