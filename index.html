<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>God's Plan | Fórmula Corregida</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web" defer></script>

    <style>
        /* Estilos base */
        body { background-color: #0a0a0a; color: #e5e5e5; font-family: system-ui, -apple-system, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3b82f6; }
        
        /* Modales */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 50; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-overlay.is-open { display: flex; }
        .modal-content { background: #171717; width: 100%; max-width: 400px; border-radius: 16px; border: 1px solid #262626; padding: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }

        /* Chips */
        .chip { border: 1px solid #262626; background: #171717; color: #a3a3a3; padding: 6px 12px; border-radius: 999px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: #e5e5e5; color: #0a0a0a; border-color: #e5e5e5; font-weight: bold; transform: scale(1.05); }
        
        /* Toast */
        #toast { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; }
    </style>
</head>
<body class="flex flex-col h-[100dvh] overflow-hidden">

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 bg-[#0a0a0a] z-[100] flex items-center justify-center">
        <div class="text-center">
            <i class="ph-bold ph-spinner animate-spin text-3xl text-neutral-500 mb-2"></i>
            <p class="text-neutral-500 font-mono text-sm">Sincronizando...</p>
        </div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="fixed inset-0 z-[90] bg-[#0a0a0a] flex flex-col items-center justify-center p-6 hidden">
        <div class="w-full max-w-sm bg-neutral-900 border border-neutral-800 rounded-xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center mx-auto mb-4 text-black">
                     <i class="ph-bold ph-wallet text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">GOD'S PLAN</h1>
                <p class="text-neutral-500 text-xs uppercase tracking-wider">Control Financiero Estricto</p>
            </div>

            <div class="flex bg-neutral-800 p-1 rounded-lg mb-6">
                <button onclick="window.authApp.toggleAuth('login')" id="tab-login" class="flex-1 py-2 text-xs font-bold rounded bg-neutral-700 text-white transition-all">INGRESAR</button>
                <button onclick="window.authApp.toggleAuth('register')" id="tab-register" class="flex-1 py-2 text-xs font-bold text-neutral-400 transition-all">REGISTRO</button>
            </div>

            <form onsubmit="event.preventDefault(); window.authApp.handleAuthSubmit();" class="space-y-4">
                <div id="field-name" class="hidden animate-fade-in">
                    <input type="text" id="input-name" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white placeholder-neutral-600 focus:border-neutral-500 transition-colors" placeholder="Tu Nombre">
                </div>
                <div>
                    <input type="text" id="input-id" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white placeholder-neutral-600 focus:border-neutral-500 transition-colors" placeholder="Usuario o Email" required>
                </div>
                <div>
                    <input type="password" id="input-pass" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white placeholder-neutral-600 focus:border-neutral-500 transition-colors" placeholder="Contraseña" required>
                </div>

                <div id="auth-error-msg" class="hidden text-red-400 text-xs font-bold text-center py-2 bg-red-900/10 rounded border border-red-900/50">
                    <span id="auth-error-txt">Error</span>
                </div>

                <button type="submit" id="btn-submit" class="w-full bg-white text-black py-3 rounded-lg font-bold text-sm hover:bg-neutral-200 transition-colors shadow-lg shadow-white/10">
                    <span id="btn-text">INICIAR SESIÓN</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Navbar Superior -->
    <nav id="global-nav" class="h-16 bg-neutral-900/80 backdrop-blur-md border-b border-neutral-800 flex items-center justify-between px-4 shrink-0 hidden sticky top-0 z-30">
        <div class="flex items-center gap-3">
             <div class="w-9 h-9 bg-neutral-800 rounded-lg flex items-center justify-center text-white border border-neutral-700">
                <i class="ph-bold ph-wallet"></i>
            </div>
            <div>
                <h1 class="text-white font-bold text-sm leading-tight">Finanzas</h1>
                <p class="text-[10px] text-neutral-500 font-mono" id="current-date-header">...</p>
            </div>
        </div>
        
        <!-- Menú Desktop -->
        <div class="hidden md:flex gap-1 bg-neutral-900 p-1 rounded-lg border border-neutral-800">
            <button onclick="switchTab('dashboard')" class="px-4 py-1.5 rounded text-xs font-bold text-white bg-neutral-800">Panel</button>
            <button onclick="switchTab('history')" class="px-4 py-1.5 rounded text-xs font-bold text-neutral-400 hover:text-white transition-colors">Historial</button>
            <button onclick="switchTab('payments')" class="px-4 py-1.5 rounded text-xs font-bold text-neutral-400 hover:text-white transition-colors">Pagos</button>
            <button onclick="switchTab('settings')" class="px-4 py-1.5 rounded text-xs font-bold text-neutral-400 hover:text-white transition-colors">Ajustes</button>
        </div>

        <div class="w-8 md:hidden"></div> <!-- Spacer móvil -->
    </nav>

    <!-- Contenido Principal -->
    <main id="main-container" class="flex-1 overflow-y-auto p-4 md:p-6 pb-24 relative hidden scroll-smooth">
        <div class="max-w-3xl mx-auto space-y-6">

            <!-- DASHBOARD -->
            <section id="view-dashboard" class="space-y-6 animate-fade-in">
                
                <!-- Tarjeta de Balance -->
                <div class="bg-gradient-to-br from-neutral-900 to-neutral-950 border border-neutral-800 rounded-2xl p-6 shadow-xl relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                        <i class="ph-fill ph-wallet text-9xl"></i>
                    </div>

                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <span class="text-xs font-bold text-neutral-500 uppercase tracking-widest">Disponible Real</span>
                        <button onclick="openAdjustModal()" class="text-blue-400 hover:text-blue-300 text-xs font-bold bg-blue-900/20 px-2 py-1 rounded border border-blue-900/30 transition-colors">Ajustar</button>
                    </div>
                    
                    <div class="text-5xl md:text-6xl font-bold text-white mb-6 relative z-10 tracking-tight" id="total-balance">$0.00</div>
                    
                    <div class="mb-6 relative z-10">
                        <div class="flex justify-between text-[10px] font-bold text-neutral-500 mb-2 uppercase">
                            <span>Presupuesto usado</span>
                            <span id="progress-percent">0%</span>
                        </div>
                        <div class="h-3 bg-neutral-800 rounded-full w-full overflow-hidden border border-neutral-800">
                            <div id="balance-progress" class="h-full bg-white w-0 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(255,255,255,0.5)]"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 border-t border-neutral-800 pt-4 relative z-10">
                        <div>
                            <span class="block text-[10px] text-neutral-500 uppercase font-bold mb-1 flex items-center gap-1"><i class="ph-bold ph-arrow-down-left text-green-500"></i> Ingresos</span>
                            <span class="text-lg font-bold text-green-400" id="total-income">$0.00</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-[10px] text-neutral-500 uppercase font-bold mb-1 flex items-center justify-end gap-1">Gastos <i class="ph-bold ph-arrow-up-right text-red-500"></i></span>
                            <span class="text-lg font-bold text-red-400" id="total-expense">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Fórmula del Día -->
                    <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 flex flex-col justify-between relative overflow-hidden h-full">
                        <div>
                             <div class="flex justify-between items-start mb-3">
                                <p class="text-xs font-bold text-purple-400 uppercase tracking-widest flex items-center gap-2">
                                    <i class="ph-fill ph-calculator"></i> PLAN DEL DÍA
                                </p>
                                <span id="payday-badge" class="text-[10px] bg-neutral-800 text-neutral-400 px-2 py-1 rounded border border-neutral-700 font-mono">...</span>
                            </div>
                            <p class="text-sm text-neutral-300 leading-relaxed mb-4 font-light" id="formula-explanation">Analizando tus finanzas...</p>
                        </div>
                        
                        <div class="pt-4 border-t border-neutral-800 mt-auto">
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-[10px] text-neutral-500 uppercase font-bold mb-1">Límite Diario Seguro</p>
                                    <span class="font-bold text-3xl text-white tracking-tight" id="formula-daily">$0.00</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] text-neutral-500 font-bold uppercase">Meta</p>
                                    <p id="formula-days-left" class="text-xs font-mono text-neutral-400">...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="grid grid-rows-2 gap-4 h-full">
                        <button onclick="openAddModal('income')" class="bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 hover:border-green-900/50 rounded-2xl text-green-500 font-bold text-sm flex items-center justify-center gap-3 transition-all group">
                            <div class="w-8 h-8 rounded-full bg-green-900/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-bold ph-arrow-down-left"></i>
                            </div>
                            REGISTRAR INGRESO
                        </button>
                        <button onclick="openAddModal('expense')" class="bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 hover:border-red-900/50 rounded-2xl text-red-500 font-bold text-sm flex items-center justify-center gap-3 transition-all group">
                            <div class="w-8 h-8 rounded-full bg-red-900/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-bold ph-minus"></i>
                            </div>
                            REGISTRAR GASTO
                        </button>
                    </div>
                </div>

                <!-- SIMULADOR DE INGRESO (MEJORADO) -->
                <div id="simulation-container" class="hidden bg-gradient-to-r from-blue-950/40 to-neutral-900 border border-blue-900/50 rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-blue-900/20 z-0">
                         <i class="ph-fill ph-crystal-ball text-9xl"></i>
                    </div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="bg-blue-500/20 p-1.5 rounded-lg">
                                <i class="ph-fill ph-magic-wand text-blue-400"></i>
                            </div>
                            <h3 class="text-sm font-bold text-blue-100 uppercase tracking-wide">Simulador de Futuro</h3>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-[10px] uppercase font-bold text-blue-300/70 block mb-1">Fecha Futura</label>
                                        <input type="date" id="sim-date" class="w-full bg-neutral-950/50 border border-blue-900/30 p-2.5 rounded-lg text-sm text-white focus:border-blue-500 transition-colors" onchange="runSimulation()">
                                    </div>
                                    <div>
                                        <label class="text-[10px] uppercase font-bold text-blue-300/70 block mb-1">Monto a Recibir</label>
                                        <input type="number" id="sim-amount" class="w-full bg-neutral-950/50 border border-blue-900/30 p-2.5 rounded-lg text-sm text-white focus:border-blue-500 transition-colors" placeholder="0.00" oninput="runSimulation()">
                                    </div>
                                </div>
                                <p class="text-[10px] text-blue-300/50 leading-tight">
                                    * Este cálculo simula los gastos fijos día a día hasta la fecha seleccionada para darte un presupuesto real.
                                </p>
                            </div>
                            
                            <div class="bg-neutral-950/80 rounded-xl p-4 flex flex-col justify-center border border-blue-900/30">
                                <p class="text-xs text-blue-300/70 mb-1">Nuevo límite diario proyectado:</p>
                                <p class="text-3xl font-bold text-blue-400 tracking-tight" id="sim-result">$0.00</p>
                                <p class="text-[10px] text-neutral-400 mt-2 font-mono" id="sim-details">Esperando datos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista Reciente -->
                <div>
                     <div class="flex justify-between items-center mb-4 px-1">
                         <h3 class="text-xs font-bold text-neutral-500 uppercase tracking-widest">Actividad Reciente</h3>
                         <button onclick="switchTab('history')" class="text-xs font-bold text-white hover:text-neutral-300 transition-colors">Ver Todo <i class="ph-bold ph-arrow-right"></i></button>
                    </div>
                    <div id="recent-list" class="space-y-3">
                        <!-- Items se inyectan aquí -->
                    </div>
                </div>

            </section>

            <!-- HISTORIAL -->
            <section id="view-history" class="hidden space-y-4 animate-fade-in">
                <div class="flex items-center justify-between sticky top-0 bg-[#0a0a0a] z-20 py-2 border-b border-neutral-800">
                    <h2 class="text-xl font-bold text-white">Historial</h2>
                     <div class="flex gap-2">
                        <button onclick="filterHistory('all')" class="filter-btn active chip" data-filter="all">Todos</button>
                        <button onclick="filterHistory('income')" class="filter-btn chip" data-filter="income">Ingresos</button>
                        <button onclick="filterHistory('expense')" class="filter-btn chip" data-filter="expense">Gastos</button>
                    </div>
                </div>
                <div id="full-history-list" class="space-y-6 pb-6"></div>
            </section>

            <!-- PAGOS Y DEUDAS -->
            <section id="view-payments" class="hidden space-y-8 animate-fade-in">
                
                <!-- Sección Fijos -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2"><i class="ph-bold ph-calendar-check"></i> Pagos Fijos</h2>
                        <button onclick="openModal('fixed-modal')" class="bg-white hover:bg-neutral-200 text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-plus"></i> Nuevo
                        </button>
                    </div>
                    <div class="bg-purple-900/20 border border-purple-900/50 p-4 rounded-xl text-xs text-purple-200 flex gap-3">
                        <i class="ph-fill ph-info text-lg shrink-0"></i>
                        <div>
                            Estos pagos se restan automáticamente de tu "Plan del Día" conforme se acerca la fecha de pago, asegurando que no gastes ese dinero.
                        </div>
                    </div>
                    <div id="fixed-list" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </div>

                <div class="border-t border-neutral-800"></div>

                <!-- Sección Préstamos -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2"><i class="ph-bold ph-handshake"></i> Préstamos</h2>
                        <button onclick="openLoanModal()" class="bg-white hover:bg-neutral-200 text-black px-4 py-2 rounded-full font-bold text-xs flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-plus"></i> Nuevo
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl">
                            <p class="text-[10px] text-neutral-500 uppercase font-bold mb-1">Me deben</p>
                            <p class="text-lg font-bold text-green-500" id="loans-owed-to-me">$0.00</p>
                        </div>
                        <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl">
                            <p class="text-[10px] text-neutral-500 uppercase font-bold mb-1">Debo</p>
                            <p class="text-lg font-bold text-red-500" id="loans-i-owe">$0.00</p>
                        </div>
                    </div>

                    <div id="loans-list" class="space-y-2"></div>
                </div>
            </section>

            <!-- AJUSTES -->
            <section id="view-settings" class="hidden space-y-6 animate-fade-in">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white">Configuración</h2>
                </div>
                
                <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-2xl">
                    <div class="flex items-center gap-4 mb-6 pb-6 border-b border-neutral-800">
                        <div class="w-12 h-12 bg-neutral-800 rounded-full flex items-center justify-center text-white border border-neutral-700">
                            <i class="ph-bold ph-user text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg" id="user-display-name">Usuario</h3>
                            <p class="text-xs text-neutral-500 font-mono" id="user-display-email">ID</p>
                        </div>
                    </div>
                    
                    <button onclick="window.authApp.logout()" class="w-full py-3 border border-red-900/50 text-red-500 text-xs font-bold rounded-lg hover:bg-red-900/10 transition-colors">
                        CERRAR SESIÓN
                    </button>
                </div>

                <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-2xl space-y-5">
                    <h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="ph-bold ph-calendar"></i> Frecuencia de Cobro</h3>
                    <p class="text-xs text-neutral-500">Esto ayuda a calcular los días restantes en tu Plan del Día.</p>
                    
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-3 bg-neutral-950 border border-neutral-800 rounded-lg cursor-pointer hover:border-neutral-700 transition-colors">
                            <input type="radio" name="pay-freq" value="biweekly" class="accent-white w-4 h-4" onchange="togglePaydayInput()">
                            <span class="text-sm text-neutral-300">Quincenal (15 y 30)</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-neutral-950 border border-neutral-800 rounded-lg cursor-pointer hover:border-neutral-700 transition-colors">
                            <input type="radio" name="pay-freq" value="biweekly-custom" class="accent-white w-4 h-4" onchange="togglePaydayInput()">
                            <span class="text-sm text-neutral-300">Quincenal (Personalizado)</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-neutral-950 border border-neutral-800 rounded-lg cursor-pointer hover:border-neutral-700 transition-colors">
                            <input type="radio" name="pay-freq" value="monthly" class="accent-white w-4 h-4" onchange="togglePaydayInput()">
                            <span class="text-sm text-neutral-300">Mensual</span>
                        </label>
                    </div>

                    <div id="monthly-select-container" class="hidden animate-fade-in">
                        <label class="text-[10px] text-neutral-500 font-bold uppercase block mb-1">Día de pago</label>
                        <select id="payday-select" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors"></select>
                    </div>

                    <div id="biweekly-custom-container" class="hidden grid grid-cols-2 gap-4 animate-fade-in">
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase block mb-1">Día 1</label>
                            <select id="payday-1-select" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors"></select>
                        </div>
                        <div>
                            <label class="text-[10px] text-neutral-500 font-bold uppercase block mb-1">Día 2</label>
                            <select id="payday-2-select" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors"></select>
                        </div>
                    </div>
                    
                    <button onclick="saveSettings()" class="w-full bg-white text-black py-3 rounded-lg font-bold text-xs hover:bg-neutral-200 mt-2 shadow-lg shadow-white/10 transition-colors">GUARDAR CONFIGURACIÓN</button>
                </div>
                
                 <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-2xl space-y-4">
                      <h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="ph-bold ph-faders"></i> Extras</h3>
                      <label class="flex items-center justify-between cursor-pointer p-2 hover:bg-neutral-800 rounded-lg transition-colors">
                        <div>
                             <span class="text-sm text-neutral-300 font-bold">Modo "Ahorro Forzoso"</span>
                             <p class="text-[10px] text-neutral-500">Oculta el 10% de tu saldo real.</p>
                        </div>
                        <input type="checkbox" id="toggle-forced-savings" class="accent-purple-500 w-5 h-5" onchange="saveSettings()">
                    </label>
                    <div class="border-t border-neutral-800"></div>
                    <label class="flex items-center justify-between cursor-pointer p-2 hover:bg-neutral-800 rounded-lg transition-colors">
                        <div>
                            <span class="text-sm text-neutral-300 font-bold">Habilitar Simulador</span>
                            <p class="text-[10px] text-neutral-500">Calculadora para ingresos futuros.</p>
                        </div>
                        <input type="checkbox" id="toggle-simulation" class="accent-blue-500 w-5 h-5" onchange="saveSettings()">
                    </label>
                 </div>

                <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-2xl">
                    <h3 class="font-bold text-white text-sm mb-4">Gestión de Datos</h3>
                    <div class="flex gap-3">
                        <button onclick="exportData()" class="flex-1 bg-neutral-950 border border-neutral-800 py-3 rounded-lg text-xs font-bold text-neutral-400 hover:text-white transition-colors border-dashed">Descargar JSON</button>
                        <button onclick="document.getElementById('import-file').click()" class="flex-1 bg-neutral-950 border border-neutral-800 py-3 rounded-lg text-xs font-bold text-neutral-400 hover:text-white transition-colors border-dashed">Restaurar JSON</button>
                        <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                    </div>
                    <button onclick="resetApp()" class="w-full mt-6 text-red-500 text-[10px] font-bold uppercase hover:text-red-400 transition-colors">Eliminar todos los datos y empezar de cero</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Barra Inferior Móvil -->
    <nav class="md:hidden fixed bottom-0 w-full bg-[#0a0a0a]/90 backdrop-blur-xl border-t border-neutral-800 h-20 grid grid-cols-5 z-40 pb-4 px-2" id="bottom-nav">
        <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center justify-center text-neutral-500 hover:text-white transition-colors group" id="nav-dashboard">
            <div class="p-1 rounded-full group-hover:bg-neutral-800 transition-colors mb-1">
                <i class="ph-fill ph-squares-four text-xl"></i>
            </div>
            <span class="text-[9px] font-bold">Panel</span>
        </button>
        <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center justify-center text-neutral-500 hover:text-white transition-colors group" id="nav-history">
            <div class="p-1 rounded-full group-hover:bg-neutral-800 transition-colors mb-1">
                 <i class="ph-fill ph-list-dashes text-xl"></i>
            </div>
            <span class="text-[9px] font-bold">Historial</span>
        </button>
        
        <!-- Botón Central Flotante -->
        <div class="relative -top-6 flex justify-center pointer-events-none">
            <button onclick="openAddModal('expense')" class="pointer-events-auto w-14 h-14 bg-white rounded-full flex items-center justify-center text-black shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 active:scale-95 transition-transform">
                <i class="ph-bold ph-plus text-2xl"></i>
            </button>
        </div>

        <button onclick="switchTab('payments')" class="nav-btn flex flex-col items-center justify-center text-neutral-500 hover:text-white transition-colors group" id="nav-payments">
             <div class="p-1 rounded-full group-hover:bg-neutral-800 transition-colors mb-1">
                <i class="ph-fill ph-receipt text-xl"></i>
            </div>
            <span class="text-[9px] font-bold">Pagos</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center justify-center text-neutral-500 hover:text-white transition-colors group" id="nav-settings">
             <div class="p-1 rounded-full group-hover:bg-neutral-800 transition-colors mb-1">
                <i class="ph-fill ph-gear text-xl"></i>
            </div>
            <span class="text-[9px] font-bold">Ajustes</span>
        </button>
    </nav>

    <!-- MODALES -->
    
    <!-- Transacción -->
    <div id="transaction-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
             <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-white text-lg" id="modal-tx-title">Nuevo Movimiento</h3>
                <button onclick="closeModal('transaction-modal')" class="w-8 h-8 rounded-full bg-neutral-800 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
             </div>
             
             <form id="transaction-form" onsubmit="addTransaction(event)">
                <div class="hidden">
                      <input type="radio" name="type" value="expense" id="radio-expense" checked>
                      <input type="radio" name="type" value="income" id="radio-income">
                      <input type="hidden" id="t-fixed-id">
                </div>
                
                <div class="mb-8 text-center">
                    <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-2">Monto</label>
                    <div class="relative inline-block">
                        <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl font-bold text-neutral-600">$</span>
                        <input type="number" id="t-amount" step="0.01" class="w-full bg-transparent border-b-2 border-neutral-800 text-4xl font-bold text-white py-2 pl-6 pr-2 text-center focus:border-white transition-colors placeholder-neutral-800" placeholder="0.00" required>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-3">Categoría</label>
                    <div class="flex flex-wrap gap-2 justify-center" id="category-chips"></div>
                    <input type="hidden" id="t-category" required>
                </div>
                
                <div class="space-y-4 mb-8 bg-neutral-900/50 p-4 rounded-xl border border-neutral-800">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Concepto</label>
                        <input type="text" id="t-title" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors" placeholder="Descripción corta...">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Fecha</label>
                        <input type="datetime-local" id="t-date" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button type="button" id="btn-delete-tx" onclick="deleteCurrentTransaction()" class="hidden py-3 border border-red-900/50 text-red-500 font-bold text-xs rounded-lg hover:bg-red-900/20 transition-colors">ELIMINAR</button>
                    <button type="submit" id="btn-save-tx" class="col-span-2 py-3 bg-white text-black font-bold text-xs rounded-lg hover:bg-neutral-200 shadow-lg shadow-white/10 transition-colors">GUARDAR</button>
                </div>
             </form>
        </div>
    </div>

    <!-- Ajustar Saldo -->
    <div id="adjust-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
             <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-white">Ajustar Saldo Real</h3>
                <button onclick="closeModal('adjust-modal')" class="w-8 h-8 rounded-full bg-neutral-800 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
             </div>
             <div class="bg-neutral-900 border border-neutral-800 p-4 rounded-xl mb-6 text-center">
                 <p class="text-xs text-neutral-500 uppercase font-bold mb-1">El sistema calcula:</p>
                 <p class="text-2xl font-bold text-white tracking-tight" id="adjust-current-display">$0.00</p>
             </div>
             <form onsubmit="submitAdjustment(event)">
                <div class="mb-6">
                    <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-2">¿Cuánto tienes realmente?</label>
                    <input type="number" id="adjust-amount" step="0.01" class="w-full bg-neutral-950 border border-neutral-800 p-4 rounded-xl text-3xl font-bold text-white text-center focus:border-blue-500 transition-colors" placeholder="0.00" required>
                    <p class="text-[10px] text-neutral-500 mt-2 text-center">Se creará un movimiento de "Ajuste" automáticamente.</p>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-xs hover:bg-blue-500 shadow-lg shadow-blue-900/20 transition-colors">CORREGIR SALDO</button>
             </form>
        </div>
    </div>

    <!-- Modal Fijo -->
    <div id="fixed-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-white">Nuevo Pago Fijo</h3>
                <button onclick="closeModal('fixed-modal')" class="w-8 h-8 rounded-full bg-neutral-800 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
             </div>
             <form id="fixed-form" onsubmit="addFixed(event)" class="space-y-5">
                 <div>
                      <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Nombre del Servicio</label>
                      <input type="text" id="f-title" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors" placeholder="Ej. Netflix, Renta..." required>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Monto Mensual</label>
                        <input type="number" id="f-amount" step="0.01" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors" placeholder="0.00" required>
                      </div>
                      <div>
                        <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Día del mes</label>
                        <select id="f-day" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors"></select>
                      </div>
                 </div>
                 <label class="flex items-center gap-3 cursor-pointer p-3 bg-neutral-900 border border-neutral-800 rounded-lg">
                    <input type="checkbox" id="f-include" class="accent-white w-4 h-4" checked>
                    <span class="text-xs text-neutral-300 font-bold">Descontar del Plan Diario</span>
                 </label>
                 <button type="submit" class="w-full bg-white text-black py-3 rounded-lg font-bold text-xs hover:bg-neutral-200 shadow-lg shadow-white/10 transition-colors">GUARDAR PAGO</button>
             </form>
        </div>
    </div>

    <!-- Modal Préstamos -->
    <div id="loans-modal" class="modal-overlay">
        <div class="modal-content animate-scale-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-white">Nuevo Préstamo</h3>
                <button onclick="closeModal('loans-modal')" class="w-8 h-8 rounded-full bg-neutral-800 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"><i class="ph-bold ph-x"></i></button>
            </div>
            <form onsubmit="saveLoan(event)" class="space-y-4">
                <div class="flex bg-neutral-900 rounded-lg p-1 border border-neutral-800">
                    <button type="button" onclick="setLoanType('lent')" id="btn-lent" class="flex-1 py-2 text-xs font-bold rounded-md bg-neutral-800 text-green-500 transition-all">ME DEBEN</button>
                    <button type="button" onclick="setLoanType('borrowed')" id="btn-borrowed" class="flex-1 py-2 text-xs font-bold text-neutral-500 transition-all">DEBO</button>
                </div>
                <input type="hidden" id="loan-type" value="lent">
                
                <div>
                      <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Persona</label>
                      <input type="text" id="loan-person" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors" required>
                 </div>
                 <div>
                    <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Monto</label>
                    <input type="number" id="loan-amount" step="0.01" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors" required>
                 </div>
                 <div>
                    <label class="text-[10px] uppercase font-bold text-neutral-500 block mb-1">Fecha Límite/Registro</label>
                    <input type="date" id="loan-date" class="w-full bg-neutral-950 border border-neutral-800 p-3 rounded-lg text-sm text-white focus:border-white transition-colors" required>
                </div>
                <button type="submit" class="w-full bg-white text-black py-3 rounded-lg font-bold text-xs hover:bg-neutral-200 shadow-lg shadow-white/10 transition-colors">GUARDAR</button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full shadow-[0_10px_30px_rgba(255,255,255,0.2)] z-[200] opacity-0 pointer-events-none font-bold text-xs flex items-center gap-2">
        <i class="ph-bold ph-check-circle text-lg text-green-600"></i>
        <span id="toast-msg">Mensaje</span>
    </div>

    <!-- LOGICA JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-cUzYmh5G9y_W2RXbO1Uma4DlKKmnnss",
            authDomain: "odsplan-adherencia.firebaseapp.com",
            projectId: "godsplan-adherencia",
            storageBucket: "godsplan-adherencia.firebasestorage.app",
            messagingSenderId: "660801277434",
            appId: "1:660801277434:web:3a37ece56538dc2b22a843"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let listeners = [];
        let editingTransactionId = null;

        window.appData = {
            transactions: [],
            fixed: [],
            loans: [], 
            settings: { frequency: 'biweekly', payday: null, forcedSavings: false, simulationMode: false }
        };

        // --- AUTH ---
        window.authApp = {
            isRegistering: false,
            toggleAuth(mode) {
                this.isRegistering = (mode === 'register');
                const nameField = document.getElementById('field-name');
                const btnLogin = document.getElementById('tab-login');
                const btnReg = document.getElementById('tab-register');
                
                document.getElementById('auth-error-msg').classList.add('hidden');
                document.getElementById('btn-text').textContent = this.isRegistering ? "CREAR CUENTA" : "INICIAR SESIÓN";
                
                if (this.isRegistering) {
                    nameField.classList.remove('hidden');
                    btnReg.className = "flex-1 py-2 text-xs font-bold rounded bg-neutral-700 text-white shadow-lg";
                    btnLogin.className = "flex-1 py-2 text-xs font-bold text-neutral-400 hover:text-white";
                } else {
                    nameField.classList.add('hidden');
                    btnLogin.className = "flex-1 py-2 text-xs font-bold rounded bg-neutral-700 text-white shadow-lg";
                    btnReg.className = "flex-1 py-2 text-xs font-bold text-neutral-400 hover:text-white";
                }
            },
            async handleAuthSubmit() {
                const btn = document.getElementById('btn-submit');
                const id = document.getElementById('input-id').value.trim();
                const pass = document.getElementById('input-pass').value;
                const name = document.getElementById('input-name').value.trim();
                
                if (!id || !pass) return this.showError("Faltan datos");
                if (this.isRegistering && !name) return this.showError("Nombre requerido");
                
                const finalId = id.includes('@') ? id : `${id}@godsplan.site`;
                btn.disabled = true;
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i>';

                try {
                    if (this.isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, finalId, pass);
                        await updateProfile(cred.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(auth, finalId, pass);
                    }
                } catch (error) {
                    this.showError("Credenciales inválidas");
                    btn.disabled = false;
                    btn.innerHTML = '<span id="btn-text">REINTENTAR</span>';
                }
            },
            showError(msg) {
                document.getElementById('auth-error-txt').textContent = msg;
                document.getElementById('auth-error-msg').classList.remove('hidden');
            },
            logout() {
                if(confirm('¿Cerrar sesión?')) signOut(auth);
            }
        };

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) {}
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                document.getElementById('global-nav').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                
                document.getElementById('user-display-name').textContent = user.displayName || 'Usuario';
                document.getElementById('user-display-email').textContent = user.email;

                document.getElementById('loading-screen').classList.add('hidden');
                setupListeners(user.uid);
            } else {
                currentUser = null;
                document.getElementById('main-container').classList.add('hidden');
                document.getElementById('global-nav').classList.add('hidden');
                document.getElementById('bottom-nav').classList.add('hidden');
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
            }
        });

        function setupListeners(userId) {
            listeners.forEach(u => u()); listeners = [];
            
            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'transactions'), (snap) => {
                window.appData.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDashboard(); renderHistory(); renderFixed();
            }));

            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'fixed'), (snap) => {
                window.appData.fixed = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFixed(); renderDashboard();
            }));

            listeners.push(onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'loans'), (snap) => {
                window.appData.loans = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderLoans();
            }));

            listeners.push(onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config'), (snap) => {
                if(snap.exists()) window.appData.settings = { ...window.appData.settings, ...snap.data() };
                setupSettingsUI(); renderDashboard();
            }));
        }

        // --- FUNCIONES GLOBAL ---
        window.openAddModal = function(type, fixedId = null) {
            editingTransactionId = null;
            document.getElementById('modal-tx-title').textContent = type === 'expense' ? "Nuevo Gasto" : "Nuevo Ingreso";
            document.getElementById('btn-save-tx').textContent = "GUARDAR";
            document.getElementById('btn-delete-tx').classList.add('hidden');
            document.getElementById('btn-save-tx').classList.add('col-span-2');
            document.getElementById('transaction-form').reset();
            
            const now = new Date();
            const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('t-date').value = localIso;
            
            document.getElementById(type === 'expense' ? 'radio-expense' : 'radio-income').checked = true;
            document.getElementById('t-fixed-id').value = fixedId || ''; 
            
            renderCategoryChips(type);
            openModal('transaction-modal');
        };

        window.addTransaction = async function(e) {
            e.preventDefault();
            if (!currentUser) return;
            
            const type = document.querySelector('input[name="type"]:checked').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const title = document.getElementById('t-title').value || (type === 'expense' ? 'Gasto' : 'Ingreso');
            const category = document.getElementById('t-category').value || 'General';
            const date = document.getElementById('t-date').value; 
            const fixedPaymentId = document.getElementById('t-fixed-id').value;

            const txData = { type, amount, title, category, date, createdAt: new Date().toISOString() };
            if(fixedPaymentId) txData.fixedPaymentId = fixedPaymentId;

            try {
                if (editingTransactionId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', editingTransactionId), txData);
                    showToast('Actualizado');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), txData);
                    showToast('Guardado');
                }
                closeModal('transaction-modal');
            } catch(e) { console.error(e); }
        };

        window.deleteCurrentTransaction = async function() {
            if(!editingTransactionId) return;
            if(confirm('¿Eliminar permanentemente?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', editingTransactionId));
                showToast('Eliminado');
                closeModal('transaction-modal');
            }
        }

        window.editTransaction = function(id) {
            const tx = window.appData.transactions.find(t => t.id === id);
            if(!tx) return;
            editingTransactionId = id;
            document.getElementById('modal-tx-title').textContent = "Editar Movimiento";
            document.getElementById('btn-save-tx').textContent = "ACTUALIZAR";
            document.getElementById('btn-delete-tx').classList.remove('hidden');
            document.getElementById('btn-save-tx').classList.remove('col-span-2');
            
            document.getElementById('t-amount').value = tx.amount;
            document.getElementById('t-title').value = tx.title;
            
            let dateVal = tx.date;
            if (dateVal && dateVal.length === 10) dateVal += "T12:00";
            document.getElementById('t-date').value = dateVal;
            
            document.getElementById(tx.type === 'expense' ? 'radio-expense' : 'radio-income').checked = true;
            document.getElementById('t-fixed-id').value = tx.fixedPaymentId || '';
            
            renderCategoryChips(tx.type);
            selectChip(tx.category);
            openModal('transaction-modal');
        };

        window.addFixed = async function(e) {
            e.preventDefault();
            const title = document.getElementById('f-title').value;
            const amount = parseFloat(document.getElementById('f-amount').value);
            const day = document.getElementById('f-day').value;
            const include = document.getElementById('f-include').checked;
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed'), { 
                title, amount, day, ignoreBudget: !include 
            });
            closeModal('fixed-modal');
            showToast('Guardado');
        };

        window.payFixed = function(id) {
            const f = window.appData.fixed.find(x => x.id === id);
            window.openAddModal('expense', id); 
            document.getElementById('t-amount').value = f.amount;
            document.getElementById('t-title').value = f.title;
            selectChip('Servicios');
        };

        window.deleteFixed = async function(id) {
            if(confirm('¿Borrar?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', id));
        };
        
        window.toggleFixedIgnore = async function(id, current) {
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', id), { ignoreBudget: !current });
        };

        window.openLoanModal = function() {
            document.getElementById('loan-person').value = '';
            document.getElementById('loan-amount').value = '';
            document.getElementById('loan-date').value = new Date().toISOString().split('T')[0];
            setLoanType('lent');
            openModal('loans-modal');
        };

        window.setLoanType = function(type) {
            const btnLent = document.getElementById('btn-lent');
            const btnBorrowed = document.getElementById('btn-borrowed');
            document.getElementById('loan-type').value = type;

            if (type === 'lent') {
                btnLent.className = "flex-1 py-2 text-xs font-bold rounded-md bg-neutral-800 text-green-500 transition-colors border border-green-900/30";
                btnBorrowed.className = "flex-1 py-2 text-xs font-bold text-neutral-500 transition-colors";
            } else {
                btnBorrowed.className = "flex-1 py-2 text-xs font-bold rounded-md bg-neutral-800 text-red-500 transition-colors border border-red-900/30";
                btnLent.className = "flex-1 py-2 text-xs font-bold text-neutral-500 transition-colors";
            }
        };

        window.saveLoan = async function(e) {
            e.preventDefault();
            const type = document.getElementById('loan-type').value;
            const person = document.getElementById('loan-person').value;
            const amount = parseFloat(document.getElementById('loan-amount').value);
            const date = document.getElementById('loan-date').value;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'loans'), {
                    type, person, amount, date, createdAt: new Date().toISOString()
                });
                closeModal('loans-modal');
                showToast('Guardado');
            } catch(e) { console.error(e); }
        };

        window.deleteLoan = async function(id) {
             if(confirm('¿Borrar?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'loans', id));
                showToast('Eliminado');
             }
        };

        window.saveSettings = async function() {
            const freq = document.querySelector('input[name="pay-freq"]:checked').value;
            const payday = document.getElementById('payday-select').value;
            const payday1 = document.getElementById('payday-1-select').value;
            const payday2 = document.getElementById('payday-2-select').value;
            const forcedSavings = document.getElementById('toggle-forced-savings').checked;
            const simulationMode = document.getElementById('toggle-simulation').checked;
            
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'config'), { 
                frequency: freq, payday, payday1, payday2, forcedSavings, simulationMode
            }, { merge: true });
            showToast('Guardado');
        };

        window.resetApp = async function() {
            if(confirm('¿ESTÁS SEGURO? ESTO BORRARÁ TODO PERMANENTEMENTE.')) {
                const txs = window.appData.transactions;
                const fxs = window.appData.fixed;
                const loans = window.appData.loans;
                
                txs.forEach(t => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', t.id)));
                fxs.forEach(f => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed', f.id)));
                loans.forEach(l => deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'loans', l.id)));
                
                showToast('Reseteado');
            }
        };
        
        window.openAdjustModal = function() {
            let balCents = 0;
            window.appData.transactions.forEach(t => {
                const amountCents = Math.round(t.amount * 100);
                if (t.type === 'income') balCents += amountCents;
                else balCents -= amountCents;
            });
            const bal = balCents / 100;
            document.getElementById('adjust-current-display').textContent = formatCurrency(bal);
            document.getElementById('adjust-current-display').dataset.raw = bal;
            document.getElementById('adjust-amount').value = '';
            openModal('adjust-modal');
        }

        window.submitAdjustment = async function(e) {
            e.preventDefault();
            const real = parseFloat(document.getElementById('adjust-amount').value);
            const sys = parseFloat(document.getElementById('adjust-current-display').dataset.raw);
            const diff = (Math.round(real * 100) - Math.round(sys * 100)) / 100;
            
            if(Math.abs(diff) < 0.01) return closeModal('adjust-modal');
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), {
                type: diff > 0 ? 'income' : 'expense',
                amount: Math.abs(diff),
                title: 'Ajuste Manual de Saldo',
                category: 'Ajuste',
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            });
            closeModal('adjust-modal');
            showToast('Ajustado');
        }

        window.exportData = function() {
            const data = { transactions: window.appData.transactions, fixed: window.appData.fixed, loans: window.appData.loans, settings: window.appData.settings };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "godsplan_backup.json"; a.click();
        }

        window.importData = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const json = JSON.parse(e.target.result);
                if(json.transactions) json.transactions.forEach(t => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), t));
                if(json.fixed) json.fixed.forEach(f => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'fixed'), f));
                if(json.loans) json.loans.forEach(l => addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'loans'), l));
                showToast('Datos Importados');
            };
            reader.readAsText(file);
        }

        initAuth();
    </script>

    <script>
        let currentViewDate = new Date();
        
        const COMMON_HOLIDAYS = ['01-01', '02-05', '03-21', '05-01', '09-16', '11-20', '12-25'];

        const CATEGORIES = {
            expense: [
                { id: 'Comida', icon: 'ph-hamburger' },
                { id: 'Transporte', icon: 'ph-car' },
                { id: 'Hogar', icon: 'ph-house' },
                { id: 'Ocio', icon: 'ph-film-strip' },
                { id: 'Salud', icon: 'ph-heartbeat' },
                { id: 'Servicios', icon: 'ph-lightning' },
                { id: 'Educación', icon: 'ph-graduation-cap' },
                { id: 'Ropa', icon: 'ph-t-shirt' },
                { id: 'Otros', icon: 'ph-dots-three-circle' },
                { id: 'Ajuste', icon: 'ph-scales' }
            ],
            income: [
                { id: 'Nómina', icon: 'ph-money' },
                { id: 'Venta', icon: 'ph-tag' },
                { id: 'Regalo', icon: 'ph-gift' },
                { id: 'Freelance', icon: 'ph-laptop' },
                { id: 'Ajuste', icon: 'ph-scales' },
                { id: 'Otro', icon: 'ph-dots-three-circle' }
            ]
        };

        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
        
        function updateDateHeader() {
            const str = currentViewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('current-date-header').textContent = str.charAt(0).toUpperCase() + str.slice(1);
        }

        function isFixedPaidThisMonth(fixedId) {
            const now = new Date();
            const m = now.getMonth();
            const y = now.getFullYear();
            return window.appData.transactions.some(t => {
                if (!t.date) return false;
                const d = new Date(t.date);
                if (isNaN(d.getTime())) return false; 
                return t.fixedPaymentId === fixedId && d.getMonth() === m && d.getFullYear() === y;
            });
        }

        function renderDashboard() {
            if (!window.appData || !window.appData.transactions) return;
            
            const m = currentViewDate.getMonth();
            const y = currentViewDate.getFullYear();
            
            const monthlyTx = window.appData.transactions.filter(t => {
                if (!t.date) return false;
                const d = new Date(t.date);
                if(isNaN(d.getTime())) return false;
                return d.getMonth() === m && d.getFullYear() === y;
            });

            let incMCents = 0, expMCents = 0;
            monthlyTx.forEach(t => {
                const val = Math.round(t.amount * 100);
                if (t.type === 'income') incMCents += val;
                else expMCents += val;
            });
            const incM = incMCents / 100;
            const expM = expMCents / 100;
            
            let incTCents = 0, expTCents = 0;
            window.appData.transactions.forEach(t => {
                 const val = Math.round(t.amount * 100);
                 if (t.type === 'income') incTCents += val;
                 else expTCents += val;
            });
            
            const totalBalanceReal = (incTCents - expTCents) / 100;

            const showInc = incM;
            const showExp = expM;
            let bal = totalBalanceReal; 

            if (window.appData.settings.forcedSavings) {
                bal = bal * 0.90; 
            }

            document.getElementById('total-balance').textContent = formatCurrency(bal);
            document.getElementById('total-income').textContent = formatCurrency(showInc);
            document.getElementById('total-expense').textContent = formatCurrency(showExp);

            // Progress bar calc using Total Monthly Income vs Expense
            // Using logic: If Income is 0, bar is full if expense > 0.
            const totalMonthlyIncome = incM;
            const totalMonthlyExpense = expM;
            
            let percent = 0;
            if (totalMonthlyIncome > 0) {
                 percent = Math.min((totalMonthlyExpense / totalMonthlyIncome) * 100, 100);
            } else if (totalMonthlyExpense > 0) {
                percent = 100;
            }
            
            document.getElementById('balance-progress').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;
            
            // Color logic for bar
            const bar = document.getElementById('balance-progress');
            bar.className = `h-full w-0 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(255,255,255,0.5)] ${percent > 90 ? 'bg-red-500' : (percent > 60 ? 'bg-yellow-400' : 'bg-white')}`;

            const listEl = document.getElementById('recent-list');
            const displayTx = monthlyTx;
            
            displayTx.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if(displayTx.length === 0) {
                listEl.innerHTML = '<div class="text-center text-neutral-600 text-xs py-4 italic">Sin movimientos este mes</div>';
            } else {
                const listHTML = displayTx.slice(0, 5).map(t => createTxHTML(t)).join('');
                listEl.innerHTML = listHTML;
            }
            
            updatePaydayInfo(totalBalanceReal);

            const simContainer = document.getElementById('simulation-container');
            if (window.appData.settings.simulationMode) {
                simContainer.classList.remove('hidden');
            } else {
                simContainer.classList.add('hidden');
            }
        }

        function createTxHTML(t) {
            const isInc = t.type === 'income';
            const catObj = [...CATEGORIES.expense, ...CATEGORIES.income].find(c => c.id === t.category);
            const icon = catObj ? catObj.icon : 'ph-circle';
            
            let dateDisplay = '';
            if (t.date) {
                const d = new Date(t.date);
                if (!isNaN(d.getTime())) {
                       dateDisplay = d.getDate() + '/' + (d.getMonth()+1);
                }
            }

            return `
            <div class="flex justify-between items-center p-3 rounded-xl bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 hover:border-neutral-700 cursor-pointer transition-all group" onclick="editTransaction('${t.id}')">
                <div class="flex items-center gap-3 overflow-hidden flex-1">
                    <div class="w-9 h-9 rounded-lg bg-neutral-800 flex items-center justify-center text-neutral-400 border border-neutral-700 group-hover:border-neutral-600 group-hover:text-white transition-colors shrink-0">
                        <i class="ph-fill ${icon} text-lg"></i>
                    </div>
                    <div class="min-w-0">
                        <h4 class="font-bold text-neutral-300 text-xs truncate group-hover:text-white transition-colors">${t.title}</h4>
                        <p class="text-[10px] text-neutral-500 uppercase font-bold truncate">
                            ${t.category} • ${dateDisplay}
                        </p>
                    </div>
                </div>
                <span class="font-bold text-sm ${isInc ? 'text-green-500' : 'text-neutral-200'} ml-2">
                    ${isInc ? '+' : '-'}${formatCurrency(t.amount)}
                </span>
            </div>
            `;
        }

        function renderHistory() {
            const activeBtn = document.querySelector('.filter-btn.active');
            const filter = activeBtn ? activeBtn.dataset.filter : 'all';
            
            const list = document.getElementById('full-history-list');
            list.innerHTML = '';
            
            let txs = [...window.appData.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
            if(filter !== 'all') txs = txs.filter(t => t.type === filter);
            
            if(txs.length === 0) {
                list.innerHTML = '<div class="text-center text-neutral-600 py-8 text-xs flex flex-col items-center gap-2"><i class="ph-bold ph-ghost text-2xl"></i><span>Sin registros aún</span></div>';
                return;
            }

            const grouped = {};
            txs.forEach(t => {
                if(!t.date) return;
                const dateKey = t.date.substring(0, 10);
                if(!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(t);
            });

            Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                const groupDiv = document.createElement('div');
                const dateObj = new Date(date + 'T00:00:00');
                
                const today = new Date(); today.setHours(0,0,0,0);
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
                
                let label = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                if(dateObj.getTime() === today.getTime()) label = "Hoy";
                else if(dateObj.getTime() === yesterday.getTime()) label = "Ayer";
                label = label.charAt(0).toUpperCase() + label.slice(1);

                const txItemsHTML = grouped[date].map(t => createTxHTML(t)).join('');
                
                groupDiv.innerHTML = `
                    <div class="sticky top-12 bg-[#0a0a0a]/95 backdrop-blur-sm z-10 py-1 mb-2 border-b border-neutral-800/50">
                        <h3 class="text-[10px] font-bold text-neutral-500 uppercase tracking-widest pl-1">${label}</h3>
                    </div>
                    <div class="space-y-1">
                        ${txItemsHTML}
                    </div>
                `;
                list.appendChild(groupDiv);
            });
        }

        function renderFixed() {
            const list = document.getElementById('fixed-list');
            if(window.appData.fixed.length === 0) {
                list.innerHTML = '<div class="text-center text-neutral-600 py-4 col-span-full text-xs italic">No has configurado pagos fijos</div>';
                return;
            }

            const fixedHTML = window.appData.fixed.map(f => {
                const isPaid = isFixedPaidThisMonth(f.id);
                const isIgnored = f.ignoreBudget;
                
                const bgClass = isPaid ? "bg-green-900/10 border-green-900/30" : "bg-neutral-900 border-neutral-800";
                const textClass = isPaid ? "text-green-500" : (isIgnored ? "text-neutral-500 line-through" : "text-neutral-200");
                
                const eyeIcon = isIgnored ? 'ph-eye-slash' : 'ph-eye';
                const eyeColor = isIgnored ? 'text-neutral-600' : 'text-blue-500';
                
                const actionBtn = isPaid 
                    ? `<div class="w-8 h-8 rounded-lg flex items-center justify-center text-green-500"><i class="ph-bold ph-check-circle text-xl"></i></div>`
                    : `<button onclick="payFixed('${f.id}')" class="w-8 h-8 rounded-lg bg-neutral-800 flex items-center justify-center text-neutral-400 hover:text-white hover:bg-neutral-700 transition-all"><i class="ph-bold ph-check"></i></button>`;

                return `
                <div class="${bgClass} border p-3 rounded-xl flex justify-between items-center transition-all">
                    <div>
                        <p class="font-bold ${textClass} text-xs mb-0.5">${f.title}</p>
                        <p class="text-[10px] text-neutral-500 font-bold uppercase flex items-center gap-1">
                             <i class="ph-bold ph-calendar-blank"></i> Día ${f.day} • ${formatCurrency(f.amount)}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleFixedIgnore('${f.id}', ${!!isIgnored})" class="w-8 h-8 rounded-lg flex items-center justify-center ${eyeColor} hover:bg-neutral-800 transition-colors"><i class="ph-bold ${eyeIcon}"></i></button>
                        ${actionBtn}
                        <button onclick="deleteFixed('${f.id}')" class="w-8 h-8 rounded-lg flex items-center justify-center text-neutral-600 hover:text-red-500 hover:bg-neutral-800 transition-colors"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
                `;
            }).join('');

            list.innerHTML = fixedHTML;
        }

        function renderLoans() {
            const list = document.getElementById('loans-list');
            const loans = window.appData.loans || [];

            let owedToMe = 0;
            let iOwe = 0;

            loans.forEach(l => {
                const val = parseFloat(l.amount) || 0;
                if(l.type === 'lent') owedToMe += val;
                else iOwe += val;
            });

            document.getElementById('loans-owed-to-me').textContent = formatCurrency(owedToMe);
            document.getElementById('loans-i-owe').textContent = formatCurrency(iOwe);

            if(loans.length === 0) {
                list.innerHTML = '<div class="text-center text-neutral-600 py-4 col-span-full text-xs italic">Sin préstamos activos</div>';
                return;
            }

            const html = loans.map(l => {
                const isLent = l.type === 'lent'; 
                const icon = isLent ? 'ph-arrow-up-right' : 'ph-arrow-down-left';
                const color = isLent ? 'text-green-500' : 'text-red-500';
                const bgIcon = isLent ? 'bg-green-900/20' : 'bg-red-900/20';

                return `
                <div class="bg-neutral-900 border border-neutral-800 p-3 rounded-xl flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-lg ${bgIcon} flex items-center justify-center ${color} shrink-0">
                            <i class="ph-bold ${icon} text-lg"></i>
                        </div>
                        <div>
                            <p class="font-bold text-neutral-300 text-xs">${l.person}</p>
                            <p class="text-[10px] text-neutral-500 font-bold uppercase">${l.date}</p>
                        </div>
                    </div>
                     <div class="flex items-center gap-3">
                        <p class="font-bold ${color} text-xs">${formatCurrency(l.amount)}</p>
                        <button onclick="deleteLoan('${l.id}')" class="text-neutral-600 hover:text-red-500 transition-colors"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
                `;
            }).join('');

            list.innerHTML = html;
        }

        /**
         * LÓGICA CORE: Calcular gastos fijos pendientes
         * Recorre día por día desde mañana hasta la fecha objetivo
         * para detectar CADA instancia de pago fijo, sin importar el mes.
         */
        function getPendingFixedAmount(targetDate) {
            let pending = 0;
            let cursor = new Date();
            cursor.setHours(0,0,0,0);
            cursor.setDate(cursor.getDate() + 1); // Empezamos a contar desde mañana

            const end = new Date(targetDate);
            end.setHours(0,0,0,0);

            // Bucle día por día
            while (cursor <= end) {
                const dayNum = cursor.getDate();
                const isCurrentMonth = (cursor.getMonth() === new Date().getMonth() && cursor.getFullYear() === new Date().getFullYear());

                window.appData.fixed.forEach(f => {
                    if (f.ignoreBudget) return;
                    
                    // Si el día del pago fijo coincide con el día del cursor
                    if (parseInt(f.day) === dayNum) {
                        // Si es este mes Y ya está pagado, no lo sumamos.
                        // Si es otro mes, asumimos que NO está pagado (a menos que tengamos lógica compleja de historial futuro)
                        if (isCurrentMonth && isFixedPaidThisMonth(f.id)) {
                            return; 
                        }
                        // En cualquier otro caso (otro mes, o este mes no pagado), suma.
                        pending += parseFloat(f.amount);
                    }
                });

                cursor.setDate(cursor.getDate() + 1);
            }
            return pending;
        }

        function updatePaydayInfo(totalBalance) {
            const set = window.appData.settings;
            const badge = document.getElementById('payday-badge');
            
            const daysLabel = document.getElementById('formula-days-left');
            const dailyLabel = document.getElementById('formula-daily');
            const explanation = document.getElementById('formula-explanation');
            
            if(!set || (set.frequency === 'monthly' && !set.payday)) {
                badge.textContent = "Sin Config";
                daysLabel.textContent = "-";
                dailyLabel.textContent = "$0.00";
                explanation.textContent = "Ve a Ajustes para configurar tus fechas de cobro.";
                return;
            }
            
            const nextDate = getNextPayday();
            if (!nextDate) return;

            const today = new Date(); today.setHours(0,0,0,0);
            // Días restantes (incluyendo hoy para el presupuesto)
            const diff = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
            
            badge.textContent = diff <= 0 ? "Hoy Cobras" : `${diff} Días`;
            
            updateDailyFormula(totalBalance, diff, nextDate);
        }

        function getNextPayday() {
            const today = new Date(); today.setHours(0,0,0,0);
            let candidates = [];
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const s = window.appData.settings;
            
            const getSafeDate = (year, month, day) => {
                const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
                const safeDay = Math.min(day, lastDayOfMonth);
                return new Date(year, month, safeDay);
            };

            // Generar fechas candidatas para este mes y el siguiente
            for(let m = 0; m <= 1; m++) {
                let monthIndex = currentMonth + m; 
                let year = currentYear;
                if(monthIndex > 11) { monthIndex -= 12; year++; }

                if (s.frequency === 'biweekly') {
                    candidates.push(getSafeDate(year, monthIndex, 15));
                    candidates.push(getSafeDate(year, monthIndex, 30)); 
                } else if (s.frequency === 'biweekly-custom' && s.payday1 && s.payday2) {
                    candidates.push(getSafeDate(year, monthIndex, parseInt(s.payday1)));
                    candidates.push(getSafeDate(year, monthIndex, parseInt(s.payday2)));
                } else if (s.frequency === 'monthly' && s.payday) {
                    candidates.push(getSafeDate(year, monthIndex, parseInt(s.payday)));
                }
            }
            
            let adjustedCandidates = candidates.map(d => getNextBusinessDay(d));
            adjustedCandidates.sort((a,b) => a - b);
            
            for (let d of adjustedCandidates) {
                d.setHours(0,0,0,0);
                if (d >= today) return d;
            }
            return adjustedCandidates[0]; // Fallback
        }

        function getNextBusinessDay(date) {
            let d = new Date(date);
            const fmt = (x) => `${(x.getMonth()+1).toString().padStart(2,'0')}-${x.getDate().toString().padStart(2,'0')}`;

            // Ajuste simple para fines de semana (no festivos complejos para simplificar)
            // 0 = Dom, 6 = Sab
            while (d.getDay() === 0 || d.getDay() === 6) {
                d.setDate(d.getDate() + 1);
            }
            return d;
        }

        function updateDailyFormula(currentBalance, daysLeft, nextPaydayDate) {
            // 1. Gastado HOY (para restarlo del presupuesto del día si ya se gastó)
            let spentToday = 0;
            const todayDate = new Date();
            todayDate.setHours(0,0,0,0);
            
            window.appData.transactions.forEach(t => {
                if(t.type === 'expense' && t.date) {
                      const tDate = new Date(t.date);
                      tDate.setHours(0,0,0,0);
                      if(tDate.getTime() === todayDate.getTime()) {
                          spentToday += parseFloat(t.amount);
                      }
                }
            });

            // 2. Gastos Fijos Pendientes (Usando la nueva lógica robusta)
            // Calculamos hasta el día anterior al pago (porque el día de pago entra dinero)
            const calcLimitDate = new Date(nextPaydayDate);
            calcLimitDate.setDate(calcLimitDate.getDate() - 1);
            
            const pendingFixedSum = getPendingFixedAmount(calcLimitDate);

            // 3. Fórmula
            // Saldo Inicial Efectivo = (Saldo Actual + Lo gastado hoy (para ver el total del dia)) - Fijos futuros
            // Se suma spentToday al balance porque 'currentBalance' ya lo tiene restado, pero queremos el budget "del día completo"
            const startOfDayBalance = currentBalance + spentToday;
            const effectiveStartBalance = startOfDayBalance - pendingFixedSum;
            
            const divisor = daysLeft <= 0 ? 1 : daysLeft;
            
            let budgetForToday = effectiveStartBalance / divisor;
            const remainingToday = budgetForToday - spentToday;
            
            const explEl = document.getElementById('formula-explanation');

            explEl.innerHTML = `Presupuesto base: <strong class="text-white">${formatCurrency(budgetForToday)}</strong>.<br>Gastado hoy: <strong class="text-neutral-400">-${formatCurrency(spentToday)}</strong>.`;
            
            const remainingEl = document.getElementById('formula-daily');
            remainingEl.textContent = formatCurrency(remainingToday);
            
            if(remainingToday < 0) remainingEl.classList.add('text-red-500');
            else remainingEl.classList.remove('text-red-500');

            document.getElementById('formula-days-left').textContent = `Fijos pend: -${formatCurrency(pendingFixedSum)}`;
        }

        // --- LÓGICA DE SIMULACIÓN CORREGIDA ---
        window.runSimulation = function() {
            const dateInput = document.getElementById('sim-date').value;
            const amountInput = parseFloat(document.getElementById('sim-amount').value);
            const resultEl = document.getElementById('sim-result');
            const detailsEl = document.getElementById('sim-details');
            
            if (!dateInput || isNaN(amountInput)) {
                resultEl.textContent = "$0.00";
                detailsEl.textContent = "Ingresa fecha y monto futuro.";
                return;
            }

            const futureDate = new Date(dateInput + 'T00:00:00'); // Forzar local time
            const today = new Date();
            today.setHours(0,0,0,0);

            // Calcular diferencia de días
            const diffTime = futureDate - today;
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            if (diffDays <= 0) diffDays = 1; // Evitar división por cero

            // 1. Saldo Actual Real
            let currentBalance = 0;
            window.appData.transactions.forEach(t => {
                const val = Math.round(t.amount * 100);
                if (t.type === 'income') currentBalance += val;
                else currentBalance -= val;
            });
            currentBalance = currentBalance / 100;

            // 2. Gastos Fijos Pendientes (Usando la nueva lógica de bucle)
            // Calculamos fijos hasta la fecha de cobro futuro (exclusiva o inclusiva según se vea)
            // Generalmente queremos sobrevivir HASTA ese día.
            const pendingFixed = getPendingFixedAmount(futureDate);

            // 3. Fórmula del Simulador
            // Aquí asumimos que el usuario quiere saber: "¿Si cuento con ese dinero futuro, cuánto puedo gastar hoy?"
            // Esto implica "credit spending" (gastar antes de tenerlo).
            const totalPool = currentBalance + amountInput - pendingFixed;
            const dailyBudget = totalPool / diffDays;

            resultEl.textContent = formatCurrency(dailyBudget);
            if(dailyBudget < 0) resultEl.classList.add('text-red-400');
            else resultEl.classList.remove('text-red-400');

            detailsEl.innerHTML = `
                Días: <strong>${diffDays}</strong><br>
                (Saldo: ${formatCurrency(currentBalance)} + Futuro: ${formatCurrency(amountInput)} - Fijos: ${formatCurrency(pendingFixed)}) / ${diffDays}
            `;
        }

        function switchTab(id) {
            document.querySelectorAll('section[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-white'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.add('text-neutral-500'));
            
            const mobBtn = document.getElementById(`nav-${id}`);
            if(mobBtn) {
                mobBtn.classList.remove('text-neutral-500');
                mobBtn.classList.add('text-white');
            }

            if(id === 'dashboard') renderDashboard();
            if(id === 'history') renderHistory();
            if(id === 'payments') { renderFixed(); renderLoans(); }
        }

        function filterHistory(type) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.filter-btn[data-filter="${type}"]`).classList.add('active');
            renderHistory();
        }

        function renderCategoryChips(type) {
            const container = document.getElementById('category-chips');
            container.innerHTML = '';
            const list = type === 'expense' ? CATEGORIES.expense : CATEGORIES.income;
            
            list.forEach(c => {
                const div = document.createElement('div');
                div.className = "chip flex items-center gap-2";
                div.innerHTML = `<i class="ph-fill ${c.icon}"></i> ${c.id}`;
                div.onclick = () => selectChip(c.id);
                div.dataset.id = c.id;
                container.appendChild(div);
            });
        }

        function selectChip(catId) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            const selected = document.querySelector(`.chip[data-id="${catId}"]`);
            if(selected) selected.classList.add('active');
            document.getElementById('t-category').value = catId;
        }

        function setupSettingsUI() {
            if(!window.appData.settings) return;
            const s = window.appData.settings;
            const radios = document.getElementsByName('pay-freq');
            for(let r of radios) { if(r.value === s.frequency) r.checked = true; }
            
            const selPayday = document.getElementById('payday-select'); if(selPayday && s.payday) selPayday.value = s.payday;
            const selP1 = document.getElementById('payday-1-select'); if(selP1 && s.payday1) selP1.value = s.payday1;
            const selP2 = document.getElementById('payday-2-select'); if(selP2 && s.payday2) selP2.value = s.payday2;
            
            const toggle = document.getElementById('toggle-forced-savings');
            if(toggle && s.forcedSavings !== undefined) toggle.checked = s.forcedSavings;
            
            const toggleSim = document.getElementById('toggle-simulation');
            if(toggleSim && s.simulationMode !== undefined) toggleSim.checked = s.simulationMode;

            togglePaydayInput();
        }

        function togglePaydayInput() {
            const freq = document.querySelector('input[name="pay-freq"]:checked')?.value || 'biweekly';
            const mCont = document.getElementById('monthly-select-container');
            const bCont = document.getElementById('biweekly-custom-container');
            
            if (mCont) mCont.classList.add('hidden');
            if (bCont) bCont.classList.add('hidden');
            
            if (freq === 'monthly' && mCont) mCont.classList.remove('hidden');
            if (freq === 'biweekly-custom' && bCont) bCont.classList.remove('hidden');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('is-open');
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('is-open');
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            setTimeout(() => {
                 t.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sels = [document.getElementById('f-day'), document.getElementById('payday-select'), document.getElementById('payday-1-select'), document.getElementById('payday-2-select')];
            sels.forEach(s => {
                if(s) {
                    for(let i=1; i<=31; i++) s.innerHTML += `<option value="${i}">${i}</option>`;
                }
            });
            updateDateHeader();
        });

        // Exponer funciones globales
        window.switchTab = switchTab;
        window.filterHistory = filterHistory;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.togglePaydayInput = togglePaydayInput;
    </script>
</body>
</html>
